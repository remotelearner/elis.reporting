diff --git a/blocks/section_links/block_section_links.php b/blocks/section_links/block_section_links.php
index c25e6c1..13f8697 100644
--- a/blocks/section_links/block_section_links.php
+++ b/blocks/section_links/block_section_links.php
@@ -1,32 +1,55 @@
-<?PHP //$Id$
-
+<?php
+
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+
+/**
+ * Section links block
+ *
+ * @package    moodlecore
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
 class block_section_links extends block_base {
 
     function init() {
-        $this->title = get_string('blockname', 'block_section_links');
-        $this->version = 2007101511;
+        $this->title = get_string('pluginname', 'block_section_links');
     }
 
     function instance_config($instance) {
+        global $DB;
+
         parent::instance_config($instance);
-        $course = get_record('course', 'id', $this->instance->pageid);
+        $course = $this->page->course;
         if (isset($course->format)) {
             if ($course->format == 'topics') {
                 $this->title = get_string('topics', 'block_section_links');
             } else if ($course->format == 'weeks') {
                 $this->title = get_string('weeks', 'block_section_links');
             } else {
-                $this->title = get_string('blockname', 'block_section_links');
+                $this->title = get_string('pluginname', 'block_section_links');
             }
         }
     }
 
     function applicable_formats() {
-        return (array('course-view-weeks' => true, 'course-view-topics' => true, 'course-edit-weeks' => true, 'course-edit-topics' => true));
+        return (array('course-view-weeks' => true, 'course-view-topics' => true));
     }
 
     function get_content() {
-        global $CFG, $USER, $COURSE;
+        global $CFG, $USER, $DB;
 
         $highlight = 0;
         if(isset($this->config)){
@@ -47,11 +70,7 @@ class block_section_links extends block_base {
             return $this->content;
         }
 
-        if ($this->instance->pageid == $COURSE->id) {
-            $course = $COURSE;
-        } else {
-            $course = get_record('course', 'id', $this->instance->pageid);
-        }
+        $course = $this->page->course;
         $context = get_context_instance(CONTEXT_COURSE, $course->id);
 
         if ($course->format == 'weeks' or $course->format == 'weekscss') {
@@ -82,22 +101,22 @@ class block_section_links extends block_base {
             }
         }
 
-        if (!empty($USER->id)) {
-            $display = get_field('course_display', 'display', 'course', $this->instance->pageid, 'userid', $USER->id);
+        if (isloggedin()) {
+            $display = $DB->get_field('course_display', 'display', array('course'=>$this->page->course->id, 'userid'=>$USER->id));
         }
         if (!empty($display)) {
-            $link = $CFG->wwwroot.'/course/view.php?id='.$this->instance->pageid.'&amp;'.$sectionname.'=';
+            $link = $CFG->wwwroot.'/course/view.php?id='.$this->page->course->id.'&amp;'.$sectionname.'=';
         } else {
-            $link = '#sectionblock-';
+            $link = '#section-';
         }
 
         $sql = "SELECT section, visible
-                  FROM {$CFG->prefix}course_sections
-                 WHERE course = $course->id AND
+                  FROM {course_sections}
+                 WHERE course = ? AND
                        section < ".($course->numsections+1)."
               ORDER BY section";
 
-        if ($sections = get_records_sql($sql)) {
+        if ($sections = $DB->get_records_sql($sql, array($course->id))) {
             $text = '<ol class="inline-list">';
             for ($i = $inc; $i <= $course->numsections; $i += $inc) {
                 if (!isset($sections[$i])) {
@@ -135,8 +154,13 @@ class block_section_links extends block_base {
         return true;
     }
     function before_delete() {
-        delete_records('config_plugins', 'plugin', 'blocks/section_links');
+        global $DB;
+        $DB->delete_records('config_plugins', array('plugin' => 'blocks/section_links'));
+    }
+
+    function has_config() {
+        return true;
     }
 }
 
-?>
+
