diff --git a/admin/mnet/index.php b/admin/mnet/index.php
index ee017d9..54a0a27 100644
--- a/admin/mnet/index.php
+++ b/admin/mnet/index.php
@@ -1,4 +1,4 @@
-<?PHP // $Id$
+<?PHP
 
     // Allows the admin to configure mnet stuff
 
@@ -13,23 +13,19 @@
 
     require_capability('moodle/site:config', $context, $USER->id, true, "nopermissions");
 
+    $site = get_site();
+    $mnet = get_mnet_environment();
 
     if (!extension_loaded('openssl')) {
-        admin_externalpage_print_header();
+        echo $OUTPUT->header();
         set_config('mnet_dispatcher_mode', 'off');
-        print_error('requiresopenssl', 'mnet', '', NULL, true);
-    }
-
-    if (!$site = get_site()) {
-        admin_externalpage_print_header();
-        set_config('mnet_dispatcher_mode', 'off');
-        print_error('nosite', '', '', NULL, true);
+        print_error('requiresopenssl', 'mnet');
     }
 
     if (!function_exists('curl_init') ) {
-        admin_externalpage_print_header();
+        echo $OUTPUT->header();
         set_config('mnet_dispatcher_mode', 'off');
-        print_error('nocurl', 'mnet', '', NULL, true);
+        print_error('nocurl', 'mnet');
     }
 
     if (!isset($CFG->mnet_dispatcher_mode)) {
@@ -43,32 +39,29 @@
                 if (set_config('mnet_dispatcher_mode', $form->mode)) {
                     redirect('index.php', get_string('changessaved'));
                 } else {
-                    error('Invalid action parameter.', 'index.php');
+                    print_error('invalidaction', '', 'index.php');
                 }
             }
         } elseif (!empty($form->submit) && $form->submit == get_string('delete')) {
-            $MNET->get_private_key();
-            $_SESSION['mnet_confirm_delete_key'] = md5(sha1($MNET->keypair['keypair_PEM'])).':'.time();
-            notice_yesno(get_string("deletekeycheck", "mnet"),
-                                    "index.php?sesskey=$USER->sesskey&amp;confirm=".md5($MNET->public_key),
-                                    "index.php",
-                                     array('sesskey' => $USER->sesskey),
-                                     NULL,
-                                    'post',
-                                    'get');
+            $mnet->get_private_key();
+            $SESSION->mnet_confirm_delete_key = md5(sha1($mnet->keypair['keypair_PEM'])).':'.time();
+
+            $formcontinue = new single_button(new moodle_url('index.php', array('confirm' => md5($mnet->public_key))), get_string('yes'));
+            $formcancel = new single_button(new moodle_url('index.php', array()), get_string('no'));
+            echo $OUTPUT->confirm(get_string("deletekeycheck", "mnet"), $formcontinue, $formcancel);
             exit;
         } else {
             // We're deleting
             
             
-            if (!isset($_SESSION['mnet_confirm_delete_key'])) {
+            if (!isset($SESSION->mnet_confirm_delete_key)) {
                 // fail - you're being attacked?
             }
 
             $key = '';
             $time = '';
-            @list($key, $time) = explode(':',$_SESSION['mnet_confirm_delete_key']);
-            $MNET->get_private_key();
+            @list($key, $time) = explode(':',$SESSION->mnet_confirm_delete_key);
+            $mnet->get_private_key();
 
             if($time < time() - 60) {
                 // fail - you're out of time.
@@ -76,45 +69,36 @@
                 exit;
             }
 
-            if ($key != md5(sha1($MNET->keypair['keypair_PEM']))) {
+            if ($key != md5(sha1($mnet->keypair['keypair_PEM']))) {
                 // fail - you're being attacked?
                 print_error ('deletewrongkeyvalue', 'mnet', 'index.php');
                 exit;
             }
 
-            $MNET->replace_keys();
+            $mnet->replace_keys();
             redirect('index.php', get_string('keydeleted','mnet'));
             exit;
         }
     }
-    $hosts = get_records_select('mnet_host', " id != '{$CFG->mnet_localhost_id}' AND deleted = '0' ",'wwwroot ASC' );
+    $hosts = $DB->get_records_select('mnet_host', "id <> ? AND deleted = 0", array($CFG->mnet_localhost_id), 'wwwroot ASC');
 
-    admin_externalpage_print_header();
+    echo $OUTPUT->header();
 ?>
-<center>
 <form method="post" action="index.php">
     <table align="center" width="635" class="generalbox" border="0" cellpadding="5" cellspacing="0">
         <tr>
             <td  class="generalboxcontent">
             <table cellpadding="9" cellspacing="0" >
                 <tr valign="top">
-                    <td colspan="2" class="header" cellpadding="0"><?php print_string('aboutyourhost', 'mnet'); ?></td>
+                    <td colspan="2" class="header"><?php print_string('aboutyourhost', 'mnet'); ?></td>
                 </tr>
                 <tr valign="top">
                     <td align="right"><?php print_string('publickey', 'mnet'); ?>:</td>
-                    <td><pre><?php echo $MNET->public_key; ?></pre></td>
+                    <td><pre><?php echo $mnet->public_key; ?></pre></td>
                 </tr>
                 <tr valign="top">
                     <td align="right"><?php print_string('expires', 'mnet'); ?>:</td>
-                    <td><?php echo userdate($MNET->public_key_expires); ?></td>
-                </tr>
-                <tr valign="top">
-                    <td align="right"><?php print_string('net', 'mnet'); ?>:</td>
-                    <td><input type="hidden" name="sesskey" value="<?php echo $USER->sesskey ?>" />
-                        <input type="radio" name="mode" value="off" <?php echo ("off" == $CFG->mnet_dispatcher_mode)? 'checked="checked"' : '' ?> /> <?php print_string('off', 'mnet'); ?> <br />
-                        <input type="radio" name="mode" value="strict" <?php echo ("strict" == $CFG->mnet_dispatcher_mode)? 'checked="checked"' : '' ?> /> <?php print_string('on', 'mnet'); ?><br />
-                        <input type="submit" name="submit" value="<?php print_string('savechanges'); ?>" />
-                    </td>
+                    <td><?php echo userdate($mnet->public_key_expires); ?></td>
                 </tr>
             </table>
             </td>
@@ -127,14 +111,14 @@
             <td  class="generalboxcontent">
             <table cellpadding="9" cellspacing="0" >
                 <tr valign="top">
-                    <td colspan="2" class="header" cellpadding="0"><?php print_string('expireyourkey', 'mnet'); ?></td>
+                    <td colspan="2" class="header"><?php print_string('expireyourkey', 'mnet'); ?></td>
                 </tr>
                 <tr valign="top">
-                    <td colspan="2" cellpadding="0"><?php print_string('expireyourkeyexplain', 'mnet'); ?></td>
+                    <td colspan="2"><?php print_string('expireyourkeyexplain', 'mnet'); ?></td>
                 </tr>
                 <tr valign="top">
                     <td align="left" width="10" nowrap="nowrap"><?php print_string('expireyourkey', 'mnet'); ?></td>
-                    <td align="left"><input type="hidden" name="sesskey" value="<?php echo $USER->sesskey ?>" />
+                    <td align="left"><input type="hidden" name="sesskey" value="<?php echo sesskey() ?>" />
                         <input type="hidden" name="deleteKey" value="" />
                         <input type="submit" name="submit" value="<?php print_string('delete'); ?>" />
                     </td>
@@ -144,8 +128,6 @@
         </tr>
     </table>
 </form>
-</center>
 
 <?php
-admin_externalpage_print_footer();
-?>
+echo $OUTPUT->footer();
