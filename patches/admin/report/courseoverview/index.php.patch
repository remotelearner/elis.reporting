diff --git a/admin/report/courseoverview/index.php b/admin/report/courseoverview/index.php
index e98c067..eadb780 100644
--- a/admin/report/courseoverview/index.php
+++ b/admin/report/courseoverview/index.php
@@ -8,17 +8,17 @@
     $time       = optional_param('time', 0, PARAM_INT);
     $numcourses = optional_param('numcourses', 20, PARAM_INT);
 
-    admin_externalpage_setup('reportcourseoverview');
-    admin_externalpage_print_header();
-
     if (empty($CFG->enablestats)) {
         if (has_capability('moodle/site:config', get_context_instance(CONTEXT_SYSTEM))) {
             redirect("$CFG->wwwroot/$CFG->admin/settings.php?section=stats", get_string('mustenablestats', 'admin'), 3);
         } else {
-            error("Stats is not enabled.");
+            print_error('statsdisable');
         }
     }
 
+    admin_externalpage_setup('reportcourseoverview', '', null, '', array('pagelayout'=>'report'));
+    echo $OUTPUT->header();
+
     $course = get_site();
     stats_check_uptodate($course->id);
 
@@ -27,11 +27,9 @@
 
     $reportoptions = stats_get_report_options($course->id,STATS_MODE_RANKED);
 
-    $tableprefix = $CFG->prefix.'stats_';
-
-    $earliestday = get_field_sql('SELECT timeend FROM '.$tableprefix.'daily ORDER BY timeend');
-    $earliestweek = get_field_sql('SELECT timeend FROM '.$tableprefix.'weekly ORDER BY timeend');
-    $earliestmonth = get_field_sql('SELECT timeend FROM '.$tableprefix.'monthly ORDER BY timeend');
+    $earliestday = $DB->get_field_sql('SELECT MIN(timeend) FROM {stats_daily}');
+    $earliestweek = $DB->get_field_sql('SELECT MIN(timeend) FROM {stats_weekly}');
+    $earliestmonth = $DB->get_field_sql('SELECT MIN(timeend) FROM {stats_monthly}');
 
     if (empty($earliestday)) $earliestday = time();
     if (empty($earliestweek)) $earliestweek = time();
@@ -44,24 +42,29 @@
     $timeoptions = stats_get_time_options($now,$lastweekend,$lastmonthend,$earliestday,$earliestweek,$earliestmonth);
 
     if (empty($timeoptions)) {
-        print_error('nostatstodisplay', "", $CFG->wwwroot.'/course/view.php?id='.$course->id);
+        print_error('nostatstodisplay', 'error', $CFG->wwwroot.'/course/view.php?id='.$course->id);
     }
 
     echo '<form action="index.php" method="post">'."\n";
     echo '<div>';
 
+    $table = new html_table();
     $table->width = '*';
     $table->align = array('left','left','left','left','left','left');
-    $table->data[] = array(get_string('statsreporttype'),choose_from_menu($reportoptions,'report',$report,'','','',true),
-                           get_string('statstimeperiod'),choose_from_menu($timeoptions,'time',$time,'','','',true),
+
+    $reporttypemenu = html_writer::select($reportoptions,'report',$report, false);
+    $timeoptionsmenu = html_writer::select($timeoptions,'time',$time, false);
+
+    $table->data[] = array(get_string('statsreporttype'),$reporttypemenu,
+                           get_string('statstimeperiod'),$timeoptionsmenu,
                            '<input type="text" name="numcourses" size="3" maxlength="2" value="'.$numcourses.'" />',
                            '<input type="submit" value="'.get_string('view').'" />') ;
 
-    print_table($table);
+    echo html_writer::table($table);
     echo '</div>';
     echo '</form>';
 
-    print_heading($reportoptions[$report]);
+    echo $OUTPUT->heading($reportoptions[$report]);
 
 
     if (!empty($report) && !empty($time)) {
@@ -69,17 +72,18 @@
         if (!empty($param->sql)) {
             $sql = $param->sql;
         } else {
-            $sql = "SELECT courseid,".$param->fields." FROM ".$CFG->prefix.'stats_'.$param->table
-                ." WHERE timeend >= $param->timeafter AND stattype = 'activity' AND roleid = 0"
-                ." GROUP BY courseid "
-                .$param->extras
-                ." ORDER BY ".$param->orderby;
+            $sql = "SELECT courseid,".$param->fields."
+                      FROM {".'stats_'.$param->table."}
+                     WHERE timeend >= $param->timeafter AND stattype = 'activity' AND roleid = 0
+                  GROUP BY courseid
+                           $param->extras
+                  ORDER BY $param->orderby";
         }
 
-        $courses = get_records_sql($sql, 0, $numcourses);
+        $courses = $DB->get_records_sql($sql, $param->params, 0, $numcourses);
 
         if (empty($courses)) {
-            notify(get_string('statsnodata'));
+            echo $OUTPUT->notification(get_string('statsnodata'));
             echo '</td></tr></table>';
 
         } else {
@@ -89,7 +93,7 @@
                 echo '<div class="graph"><img alt="'.get_string('courseoverviewgraph').'" src="'.$CFG->wwwroot.'/'.$CFG->admin.'/report/courseoverview/reportsgraph.php?time='.$time.'&report='.$report.'&numcourses='.$numcourses.'" /></div>';
             }
 
-            $table = new StdClass;
+            $table = new html_table();
             $table->align = array('left','center','center','center');
             $table->head = array(get_string('course'),$param->line1);
             if (!empty($param->line2)) {
@@ -101,7 +105,7 @@
 
             foreach  ($courses as $c) {
                 $a = array();
-                $a[] = '<a href="'.$CFG->wwwroot.'/course/view.php?id='.$c->courseid.'">'.get_field('course','shortname','id',$c->courseid).'</a>';
+                $a[] = '<a href="'.$CFG->wwwroot.'/course/view.php?id='.$c->courseid.'">'.$DB->get_field('course', 'shortname', array('id'=>$c->courseid)).'</a>';
 
                 $a[] = $c->line1;
                 if (isset($c->line2)) {
@@ -112,9 +116,7 @@
                 }
                 $table->data[] = $a;
             }
-            print_table($table);
+            echo html_writer::table($table);
         }
     }
-    admin_externalpage_print_footer();
-
-?>
+    echo $OUTPUT->footer();
