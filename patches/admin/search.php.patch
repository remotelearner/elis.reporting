diff --git a/admin/search.php b/admin/search.php
index 4fcde95..55d93c0 100644
--- a/admin/search.php
+++ b/admin/search.php
@@ -1,26 +1,29 @@
-<?php // $Id$
+<?php
 
 // searches for admin settings
 
 require_once('../config.php');
 require_once($CFG->libdir.'/adminlib.php');
 
-$query = trim(stripslashes(optional_param('query', '', PARAM_NOTAGS)));  // Search string
+$query = trim(optional_param('query', '', PARAM_NOTAGS));  // Search string
 
-$adminroot =& admin_get_root(); // need all settings here
+$PAGE->set_context(get_context_instance(CONTEXT_SYSTEM));
+$PAGE->set_course($SITE);
+
+$adminroot = admin_get_root(); // need all settings here
 $adminroot->search = $query; // So we can reference it in search boxes later in this invocation
 $statusmsg = '';
 $errormsg  = '';
 $focus = '';
 
-admin_externalpage_setup('search'); // now hidden page
+admin_externalpage_setup('search', '', array('query' => $query)); // now hidden page
 
 // now we'll deal with the case that the admin has submitted the form with changed settings
 if ($data = data_submitted() and confirm_sesskey()) {
     if (admin_write_settings($data)) {
         $statusmsg = get_string('changessaved');
     }
-    $adminroot =& admin_get_root(true); //reload tree
+    $adminroot = admin_get_root(true); //reload tree
 
     if (!empty($adminroot->errors)) {
         $errormsg = get_string('errorwithsettings', 'admin');
@@ -31,13 +34,13 @@ if ($data = data_submitted() and confirm_sesskey()) {
 
 // and finally, if we get here, then there are matching settings and we have to print a form
 // to modify them
-admin_externalpage_print_header($focus);
+echo $OUTPUT->header($focus);
 
 if ($errormsg !== '') {
-    notify ($errormsg);
+    echo $OUTPUT->notification($errormsg);
 
 } else if ($statusmsg !== '') {
-    notify ($statusmsg, 'notifysuccess');
+    echo $OUTPUT->notification($statusmsg, 'notifysuccess');
 }
 
 $resultshtml = admin_search_settings_html($query); // case insensitive search only
@@ -57,6 +60,6 @@ if ($resultshtml != '') {
 echo '</fieldset>';
 echo '</form>';
 
-print_footer();
+echo $OUTPUT->footer();
+
 
-?>
