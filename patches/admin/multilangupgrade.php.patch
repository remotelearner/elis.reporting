diff --git a/admin/multilangupgrade.php b/admin/multilangupgrade.php
index 1ab04d5..77c2219 100644
--- a/admin/multilangupgrade.php
+++ b/admin/multilangupgrade.php
@@ -1,6 +1,8 @@
-<?php /// $Id$
+<?php
       /// Search and replace strings throughout all texts in the whole database
 
+define('NO_OUTPUT_BUFFERING', true);
+
 require_once('../config.php');
 require_once($CFG->dirroot.'/course/lib.php');
 require_once($CFG->libdir.'/adminlib.php');
@@ -10,57 +12,54 @@ admin_externalpage_setup('multilangupgrade');
 $go = optional_param('go', 0, PARAM_BOOL);
 
 ###################################################################
-admin_externalpage_print_header();
+echo $OUTPUT->header();
 
-print_heading(get_string('multilangupgrade', 'admin'));
+echo $OUTPUT->heading(get_string('multilangupgrade', 'admin'));
 
 $strmultilangupgrade = get_String('multilangupgradeinfo', 'admin');
 
 if (!$go or !data_submitted() or !confirm_sesskey()) {   /// Print a form
     $optionsyes = array('go'=>1, 'sesskey'=>sesskey());
-    notice_yesno($strmultilangupgrade, 'multilangupgrade.php', 'index.php', $optionsyes, null, 'post', 'get');
-    admin_externalpage_print_footer();
+    echo $OUTPUT->confirm($strmultilangupgrade, new moodle_url('multilangupgrade.php', $optionsyes), 'index.php');
+    echo $OUTPUT->footer();
     die;
 }
 
 
-if (!$tables = $db->Metatables() ) {    // No tables yet at all.
-    error("no tables");
+if (!$tables = $DB->get_tables() ) {    // No tables yet at all.
+    print_error('notables', 'debug');
 }
 
-print_simple_box_start('center');
+echo $OUTPUT->box_start();
 
 /// Turn off time limits, sometimes upgrades can be slow.
 
 @set_time_limit(0);
-@ob_implicit_flush(true);
-while(@ob_end_flush());
 
 echo '<strong>Progress:</strong>';
 $i = 0;
-$skiptables = array($CFG->prefix.'config', $CFG->prefix.'user_students', $CFG->prefix.'user_teachers');//, $CFG->prefix.'sessions2');
+$skiptables = array('config', 'user_students', 'user_teachers');
 
 foreach ($tables as $table) {
-    if (($CFG->prefix && strpos($table, $CFG->prefix) !== 0)
-      or strpos($table, $CFG->prefix.'pma') === 0) { // Not our tables
+    if (strpos($table,'pma') === 0) { // Not our tables
         continue;
     }
     if (in_array($table, $skiptables)) { // Don't process these
         continue;
     }
-    if ($columns = $db->MetaColumns($table, false)) {
-        if (!array_key_exists('id', $columns) and !array_key_exists('ID', $columns)) {
+    $fulltable = $DB->get_prefix().$table;
+    if ($columns = $DB->get_columns($table)) {
+        if (!array_key_exists('id', $columns)) {
             continue; // moodle tables have id
         }
         foreach ($columns as $column => $data) {
             if (in_array($data->type, array('text','mediumtext','longtext','varchar'))) {  // Text stuff only
                 // first find candidate records
-                $rs = get_recordset_sql("SELECT id, $column FROM $table WHERE $column LIKE '%</lang>%' OR $column LIKE '%<span lang=%'");
-                if ($rs) {
-                    while (!$rs->EOF) {
-                        $text = $rs->fields[$column];
-                        $id   = $rs->fields['id'];
-
+                $sql = "SELECT id, $column FROM $fulltable WHERE $column LIKE '%</lang>%' OR $column LIKE '%<span lang=%'";
+                $rs = $DB->get_recordset_sql($sql);
+                foreach ($rs as $data) {
+                    $text = $data->$column;
+                    $id   = $data->id;
                         if ($i % 600 == 0) {
                             echo '<br />';
                         }
@@ -68,7 +67,6 @@ foreach ($tables as $table) {
                             echo '.';
                         }
                         $i++;
-                        $rs->MoveNext();
 
                         if (empty($text) or is_numeric($text)) {
                             continue; // nothing to do
@@ -82,12 +80,10 @@ foreach ($tables as $table) {
                         }
 
                         if ($newtext != $text) {
-                            $newtext = addslashes($newtext);
-                            execute_sql("UPDATE $table SET $column='$newtext' WHERE id=$id", false);
+                        $DB->execute("UPDATE $fulltable SET $column=? WHERE id=?", array($newtext, $id));
                         }
                     }
-                    rs_close($rs);
-                }
+                $rs->close();
             }
         }
     }
@@ -96,16 +92,16 @@ foreach ($tables as $table) {
 // set conversion flag - switches to new plugin automatically
 set_config('filter_multilang_converted', 1);
 
-print_simple_box_end();
+echo $OUTPUT->box_end();
 
 /// Rebuild course cache which might be incorrect now
-notify('Rebuilding course cache...', 'notifysuccess');
+echo $OUTPUT->notification('Rebuilding course cache...', 'notifysuccess');
 rebuild_course_cache();
-notify('...finished', 'notifysuccess');
+echo $OUTPUT->notification('...finished', 'notifysuccess');
 
-print_continue('index.php');
+echo $OUTPUT->continue_button('index.php');
 
-admin_externalpage_print_footer();
+echo $OUTPUT->footer();
 die;
 
 
@@ -118,4 +114,4 @@ function multilangupgrade_impl($langblock) {
     }
     return $return;
 }
-?>
+
