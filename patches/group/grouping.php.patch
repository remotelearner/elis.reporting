diff --git a/group/grouping.php b/group/grouping.php
index a37f578..7d80e65 100644
--- a/group/grouping.php
+++ b/group/grouping.php
@@ -18,30 +18,36 @@ $id       = optional_param('id', 0, PARAM_INT);
 $delete   = optional_param('delete', 0, PARAM_BOOL);
 $confirm  = optional_param('confirm', 0, PARAM_BOOL);
 
+$url = new moodle_url('/group/grouping.php');
 if ($id) {
-    if (!$grouping = get_record('groupings', 'id', $id)) {
-        error('Group ID was incorrect');
+    $url->param('id', $id);
+    if (!$grouping = $DB->get_record('groupings', array('id'=>$id))) {
+        print_error('invalidgroupid');
     }
     $grouping->description = clean_text($grouping->description);
     if (empty($courseid)) {
         $courseid = $grouping->courseid;
-
     } else if ($courseid != $grouping->courseid) {
-        error('Course ID was incorrect');
+        print_error('invalidcourseid');
+    } else {
+        $url->param('courseid', $courseid);
     }
 
-    if (!$course = get_record('course', 'id', $courseid)) {
-        error('Course ID was incorrect');
+    if (!$course = $DB->get_record('course', array('id'=>$courseid))) {
+        print_error('invalidcourseid');
     }
 
 } else {
-    if (!$course = get_record('course', 'id', $courseid)) {
-        error('Course ID was incorrect');
+    $url->param('courseid', $courseid);
+    if (!$course = $DB->get_record('course', array('id'=>$courseid))) {
+        print_error('invalidcourseid');
     }
-    $grouping = new object();
+    $grouping = new stdClass();
     $grouping->courseid = $course->id;
 }
 
+$PAGE->set_url($url);
+
 require_login($course);
 $context = get_context_instance(CONTEXT_COURSE, $course->id);
 require_capability('moodle/course:managegroups', $context);
@@ -51,11 +57,15 @@ $returnurl = $CFG->wwwroot.'/group/groupings.php?id='.$course->id;
 
 if ($id and $delete) {
     if (!$confirm) {
-        print_header(get_string('deletegrouping', 'group'), get_string('deletegrouping', 'group'));
+        $PAGE->set_title(get_string('deletegrouping', 'group'));
+        $PAGE->set_heading($course->fullname. ': '. get_string('deletegrouping', 'group'));
+        echo $OUTPUT->header();
         $optionsyes = array('id'=>$id, 'delete'=>1, 'courseid'=>$courseid, 'sesskey'=>sesskey(), 'confirm'=>1);
         $optionsno  = array('id'=>$courseid);
-        notice_yesno(get_string('deletegroupingconfirm', 'group', $grouping->name), 'grouping.php', 'groupings.php', $optionsyes, $optionsno, 'get', 'get');
-        print_footer();
+        $formcontinue = new single_button(new moodle_url('grouping.php', $optionsyes), get_string('yes'), 'get');
+        $formcancel = new single_button(new moodle_url('groupings.php', $optionsno), get_string('no'), 'get');
+        echo $OUTPUT->confirm(get_string('deletegroupingconfirm', 'group', $grouping->name), $formcontinue, $formcancel);
+        echo $OUTPUT->footer();
         die;
 
     } else if (confirm_sesskey()){
@@ -67,8 +77,16 @@ if ($id and $delete) {
     }
 }
 
+// Prepare the description editor: We do support files for grouping descriptions
+$editoroptions = array('maxfiles'=>EDITOR_UNLIMITED_FILES, 'maxbytes'=>$course->maxbytes, 'trust'=>true, 'context'=>$context, 'noclean'=>true);
+if (!empty($grouping->id)) {
+    $grouping = file_prepare_standard_editor($grouping, 'description', $editoroptions, $context, 'grouping', 'description', $grouping->id);
+} else {
+    $grouping = file_prepare_standard_editor($grouping, 'description', $editoroptions, $context, 'grouping', 'description', null);
+}
+
 /// First create the form
-$editform = new grouping_form();
+$editform = new grouping_form(null, compact('editoroptions'));
 $editform->set_data($grouping);
 
 if ($editform->is_cancelled()) {
@@ -78,14 +96,9 @@ if ($editform->is_cancelled()) {
     $success = true;
 
     if ($data->id) {
-        if (!groups_update_grouping($data)) {
-            error('Error updating grouping');
-        }
-
+        groups_update_grouping($data, $editoroptions);
     } else {
-        if (!groups_create_grouping($data)) {
-            error('Error creating grouping');
-        }
+        groups_create_grouping($data, $editoroptions);
     }
 
     redirect($returnurl);
@@ -101,17 +114,14 @@ if ($id) {
     $strheading = get_string('creategrouping', 'group');
 }
 
-$navlinks = array(array('name'=>$strparticipants, 'link'=>$CFG->wwwroot.'/user/index.php?id='.$courseid, 'type'=>'misc'),
-                  array('name'=>$strgroupings, 'link'=>$CFG->wwwroot.'/group/groupings.php?id='.$courseid, 'type'=>'misc'),
-                  array('name'=>$strheading, 'link'=>'', 'type'=>'misc'));
-$navigation = build_navigation($navlinks);
+$PAGE->navbar->add($strparticipants, new moodle_url('/user/index.php', array('id'=>$courseid)));
+$PAGE->navbar->add($strgroupings, new moodle_url('/group/groupings.php', array('id'=>$courseid)));
+$PAGE->navbar->add($strheading);
 
 /// Print header
-print_header_simple($strgroupings, ': '.$strgroupings, $navigation, '', '', true, '', navmenu($course));
-
-
-print_heading($strheading);
+$PAGE->set_title($strgroupings);
+$PAGE->set_heading($course->fullname. ': '.$strgroupings);
+echo $OUTPUT->header();
+echo $OUTPUT->heading($strheading);
 $editform->display();
-print_footer($course);
-
-?>
+echo $OUTPUT->footer();
