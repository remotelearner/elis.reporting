diff --git a/login/change_password.php b/login/change_password.php
index 41d1a7d..2608079 100644
--- a/login/change_password.php
+++ b/login/change_password.php
@@ -1,19 +1,43 @@
-<?PHP // $Id$
-
-    require_once('../config.php');
-    require_once('change_password_form.php');
-
-    $id = optional_param('id', SITEID, PARAM_INT); // current course
-    $return = optional_param('return', 0, PARAM_BOOL); // redirect after password change
-
-    $strparticipants = get_string('participants');
-
-    //HTTPS is potentially required in this page
-    httpsrequired();
-
-    $systemcontext = get_context_instance(CONTEXT_SYSTEM);
-
-    if ($return) {
+<?php
+
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Change password page.
+ *
+ * @package    core
+ * @subpackage auth
+ * @copyright  1999 onwards Martin Dougiamas  http://dougiamas.com
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+require('../config.php');
+require_once('change_password_form.php');
+
+$id     = optional_param('id', SITEID, PARAM_INT); // current course
+$return = optional_param('return', 0, PARAM_BOOL); // redirect after password change
+
+//HTTPS is required in this page when $CFG->loginhttps enabled
+$PAGE->https_required();
+
+$PAGE->set_url('/login/change_password.php', array('id'=>$id));
+
+$PAGE->set_context(get_context_instance(CONTEXT_SYSTEM));
+
+if ($return) {
         // this redirect prevents security warning because https can not POST to http pages
         if (empty($SESSION->wantsurl)
                 or stripos(str_replace('https://', 'http://', $SESSION->wantsurl), str_replace('https://', 'http://', $CFG->wwwroot.'/login/change_password.php') === 0)) {
@@ -24,66 +48,71 @@
         unset($SESSION->wantsurl);
 
         redirect($returnto);
-    }
+}
 
-    if (!$course = get_record('course', 'id', $id)) {
-        error('No such course!');
-    }
+$strparticipants = get_string('participants');
+
+$systemcontext = get_context_instance(CONTEXT_SYSTEM);
 
-    // require proper login; guest user can not change password
-    if (empty($USER->id) or isguestuser()) {
+if (!$course = $DB->get_record('course', array('id'=>$id))) {
+    print_error('invalidcourseid');
+}
+
+// require proper login; guest user can not change password
+if (!isloggedin() or isguestuser()) {
         if (empty($SESSION->wantsurl)) {
-            $SESSION->wantsurl = $CFG->httpswwwroot.'/login/change_password.php?id=' . $id;
-        }
-        redirect($CFG->httpswwwroot.'/login/index.php');
+        $SESSION->wantsurl = $CFG->httpswwwroot.'/login/change_password.php';
     }
+    redirect(get_login_url());
+}
 
-    // do not require change own password cap if change forced
-    if (!get_user_preferences('auth_forcepasswordchange', false)) {
+// do not require change own password cap if change forced
+if (!get_user_preferences('auth_forcepasswordchange', false)) {
         require_capability('moodle/user:changeownpassword', $systemcontext);
-    }
+}
 
-    // do not allow "Logged in as" users to change any passwords
-    if (!empty($USER->realuser)) {
-        error('Can not use this script when "Logged in as"!');
-    }
+// do not allow "Logged in as" users to change any passwords
+if (session_is_loggedinas()) {
+    print_error('cannotcallscript');
+}
 
-    if (is_mnet_remote_user($USER)) {
+if (is_mnet_remote_user($USER)) {
         $message = get_string('usercannotchangepassword', 'mnet');
-        if ($idprovider = get_record('mnet_host', 'id', $USER->mnethostid)) {
+    if ($idprovider = $DB->get_record('mnet_host', array('id'=>$USER->mnethostid))) {
             $message .= get_string('userchangepasswordlink', 'mnet', $idprovider);
         }
-        error($message);
-    }
+    print_error('userchangepasswordlink', 'mnet', '', $message);
+}
 
-    // load the appropriate auth plugin
-    $userauth = get_auth_plugin($USER->auth);
+// load the appropriate auth plugin
+$userauth = get_auth_plugin($USER->auth);
 
-    if (!$userauth->can_change_password()) {
+if (!$userauth->can_change_password()) {
         print_error('nopasswordchange', 'auth');
-    }
+}
 
-    if ($changeurl = $userauth->change_password_url()) {
+if ($changeurl = $userauth->change_password_url()) {
         // this internal scrip not used
         redirect($changeurl);
-    }
+}
 
-    $mform = new login_change_password_form($CFG->httpswwwroot . '/login/change_password.php');
-    $mform->set_data(array('id'=>$course->id));
+$mform = new login_change_password_form();
+$mform->set_data(array('id'=>$course->id));
 
-    $navlinks = array();
-    $navlinks[] = array('name' => $strparticipants, 'link' => "$CFG->wwwroot/user/index.php?id=$course->id", 'type' => 'misc');
+$navlinks = array();
+$navlinks[] = array('name' => $strparticipants, 'link' => "$CFG->wwwroot/user/index.php?id=$course->id", 'type' => 'misc');
 
-    if ($mform->is_cancelled()) {
+if ($mform->is_cancelled()) {
         redirect($CFG->wwwroot.'/user/view.php?id='.$USER->id.'&amp;course='.$course->id);
-    } else if ($data = $mform->get_data()) {
+} else if ($data = $mform->get_data()) {
 
-        if (!$userauth->user_update_password(addslashes_recursive($USER), $data->newpassword1)) {
+    if (!$userauth->user_update_password($USER, $data->newpassword1)) {
             print_error('errorpasswordupdate', 'auth');
         }
 
         // register success changing password
-        unset_user_preference('auth_forcepasswordchange', $USER->id);
+    unset_user_preference('auth_forcepasswordchange', $USER);
+    unset_user_preference('create_password', $USER);
 
         $strpasswordchanged = get_string('passwordchanged');
 
@@ -91,41 +120,33 @@
 
         $fullname = fullname($USER, true);
 
-        $navlinks[] = array('name' => $fullname,
-                            'link' => "$CFG->wwwroot/user/view.php?id=$USER->id&amp;course=$course->id",
-                            'type' => 'misc');
-        $navlinks[] = array('name' => $strpasswordchanged, 'link' => null, 'type' => 'misc');
-        $navigation = build_navigation($navlinks);
-
-        print_header($strpasswordchanged, $strpasswordchanged, $navigation);
-
-        if (empty($SESSION->wantsurl) or $SESSION->wantsurl == $CFG->httpswwwroot.'/login/change_password.php') {
-            $returnto = "$CFG->wwwroot/user/view.php?id=$USER->id&amp;course=$id";
-        } else {
-            $returnto = $SESSION->wantsurl;
-        }
+    $PAGE->navbar->add($fullname, new moodle_url('/user/view.php', array('id'=>$USER->id, 'course'=>$course->id)));
+    $PAGE->navbar->add($strpasswordchanged);
+    $PAGE->set_title($strpasswordchanged);
+    $PAGE->set_heading($COURSE->fullname);
+    echo $OUTPUT->header();
 
-        notice($strpasswordchanged, $returnto);
+    notice($strpasswordchanged, new moodle_url($PAGE->url, array('return'=>1)));
 
-        print_footer();
+    echo $OUTPUT->footer();
         exit;
-    }
+}
 
+// make sure we really are on the https page when https login required
+$PAGE->verify_https_required();
 
-    $strchangepassword = get_string('changepassword');
+$strchangepassword = get_string('changepassword');
 
-    $fullname = fullname($USER, true);
+$fullname = fullname($USER, true);
 
-    $navlinks[] = array('name' => $fullname, 'link' => "$CFG->wwwroot/user/view.php?id=$USER->id&amp;course=$course->id", 'type' => 'misc');
-    $navlinks[] = array('name' => $strchangepassword, 'link' => null, 'type' => 'misc');
-    $navigation = build_navigation($navlinks);
-    // Turn off pop-up messaging window for this page
-    $CFG->messaging = 0;
-    print_header($strchangepassword, $strchangepassword, $navigation);
-    if (get_user_preferences('auth_forcepasswordchange')) {
-        notify(get_string('forcepasswordchangenotice'));
-    }
-    $mform->display();
-    print_footer();
+$PAGE->navbar->add($fullname, new moodle_url('/user/view.php', array('id'=>$USER->id, 'course'=>$course->id)));
+$PAGE->navbar->add($strchangepassword);
+$PAGE->set_title($strchangepassword);
+$PAGE->set_heading($COURSE->fullname);
+echo $OUTPUT->header();
 
-?>
+if (get_user_preferences('auth_forcepasswordchange')) {
+    echo $OUTPUT->notification(get_string('forcepasswordchangenotice'));
+}
+$mform->display();
+echo $OUTPUT->footer();
