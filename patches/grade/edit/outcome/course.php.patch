diff --git a/grade/edit/outcome/course.php b/grade/edit/outcome/course.php
index 45461b3..63462f1 100644
--- a/grade/edit/outcome/course.php
+++ b/grade/edit/outcome/course.php
@@ -15,17 +15,17 @@
 // You should have received a copy of the GNU General Public License
 // along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
 
-
 require_once '../../../config.php';
 require_once $CFG->dirroot.'/grade/lib.php';
 require_once $CFG->libdir.'/gradelib.php';
 
 $courseid = required_param('id', PARAM_INT);
 
+$PAGE->set_url('/grade/edit/outcome/course.php', array('id'=>$courseid));
+
+$course = $DB->get_record('course', array('id' => $courseid), '*', MUST_EXIST);
+
 /// Make sure they can even access this course
-if (!$course = get_record('course', 'id', $courseid)) {
-    print_error('nocourseid');
-}
 require_login($course);
 $context = get_context_instance(CONTEXT_COURSE, $course->id);
 require_capability('moodle/course:update', $context);
@@ -39,7 +39,7 @@ $co_custom           = grade_outcome::fetch_all_local($courseid);
 $co_standard_used    = array();
 $co_standard_notused = array();
 
-if ($courseused = get_records('grade_outcomes_courses', 'courseid', $courseid, '', 'outcomeid')) {
+if ($courseused = $DB->get_records('grade_outcomes_courses', array('courseid' => $courseid), '', 'outcomeid')) {
     $courseused = array_keys($courseused);
 } else {
     $courseused = array();
@@ -48,7 +48,7 @@ if ($courseused = get_records('grade_outcomes_courses', 'courseid', $courseid, '
 // fix wrong entries in outcomes_courses
 foreach ($courseused as $oid) {
     if (!array_key_exists($oid, $standardoutcomes) and !array_key_exists($oid, $co_custom)) {
-        delete_records('grade_outcomes_courses', 'outcomeid', $oid, 'courseid', $courseid);
+        $DB->delete_records('grade_outcomes_courses', array('outcomeid' => $oid, 'courseid' => $courseid));
     }
 }
 
@@ -56,18 +56,19 @@ foreach ($courseused as $oid) {
 foreach($co_custom as $oid=>$outcome) {
     if (!in_array($oid, $courseused)) {
         $courseused[$oid] = $oid;
-        $goc = new object();
+        $goc = new stdClass();
         $goc->courseid = $courseid;
         $goc->outcomeid = $oid;
-        insert_record('grade_outcomes_courses', $goc);
+        $DB->insert_record('grade_outcomes_courses', $goc);
     }
 }
 
 // now check all used standard outcomes are in outcomes_course too
+$params = array($courseid);
 $sql = "SELECT DISTINCT outcomeid
-          FROM {$CFG->prefix}grade_items
-         WHERE courseid=$courseid and outcomeid IS NOT NULL";
-if ($realused = get_records_sql($sql)) {
+          FROM {grade_items}
+         WHERE courseid=? and outcomeid IS NOT NULL";
+if ($realused = $DB->get_records_sql($sql, $params)) {
     $realused = array_keys($realused);
     foreach ($realused as $oid) {
         if (array_key_exists($oid, $standardoutcomes)) {
@@ -77,10 +78,10 @@ if ($realused = get_records_sql($sql)) {
 
             if (!in_array($oid, $courseused)) {
                 $courseused[$oid] = $oid;
-                $goc = new object();
+                $goc = new stdClass();
                 $goc->courseid = $courseid;
                 $goc->outcomeid = $oid;
-                insert_record('grade_outcomes_courses', $goc);
+                $DB->insert_record('grade_outcomes_courses', $goc);
             }
         }
     }
@@ -105,10 +106,10 @@ if ($data = data_submitted() and confirm_sesskey()) {
             if (!array_key_exists($add, $standardoutcomes)) {
                 continue;
             }
-            $goc = new object();
+            $goc = new stdClass();
             $goc->courseid = $courseid;
             $goc->outcomeid = $add;
-            insert_record('grade_outcomes_courses', $goc);
+            $DB->insert_record('grade_outcomes_courses', $goc);
         }
 
     } else if (!empty($data->remove) && !empty($data->removeoutcomes)) {
@@ -118,7 +119,7 @@ if ($data = data_submitted() and confirm_sesskey()) {
             if (!array_key_exists($remove, $co_standard_notused)) {
                 continue;
             }
-            delete_records('grade_outcomes_courses', 'courseid', $courseid, 'outcomeid', $remove);
+            $DB->delete_records('grade_outcomes_courses', array('courseid' => $courseid, 'outcomeid' => $remove));
         }
     }
     redirect('course.php?id='.$courseid); // we must redirect to get fresh data
@@ -127,8 +128,7 @@ if ($data = data_submitted() and confirm_sesskey()) {
 /// Print header
 print_grade_page_head($COURSE->id, 'outcome', 'course');
 
-check_theme_arrows();
 require('course_form.html');
 
-print_footer($course);
-?>
+echo $OUTPUT->footer();
+
