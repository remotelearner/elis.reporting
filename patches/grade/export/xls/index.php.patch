diff --git a/grade/export/xls/index.php b/grade/export/xls/index.php
old mode 100755
new mode 100644
index 5f1a159..fc509bc
--- a/grade/export/xls/index.php
+++ b/grade/export/xls/index.php
@@ -21,7 +21,9 @@ require_once 'grade_export_xls.php';
 
 $id = required_param('id', PARAM_INT); // course id
 
-if (!$course = get_record('course', 'id', $id)) {
+$PAGE->set_url('/grade/export/xls/index.php', array('id'=>$id));
+
+if (!$course = $DB->get_record('course', array('id'=>$id))) {
     print_error('nocourseid');
 }
 
@@ -31,7 +33,7 @@ $context = get_context_instance(CONTEXT_COURSE, $id);
 require_capability('moodle/grade:export', $context);
 require_capability('gradeexport/xls:view', $context);
 
-print_grade_page_head($COURSE->id, 'export', 'xls', get_string('exportto', 'grades') . ' ' . get_string('modulename', 'gradeexport_xls'));
+print_grade_page_head($COURSE->id, 'export', 'xls', get_string('exportto', 'grades') . ' ' . get_string('pluginname', 'gradeexport_xls'));
 
 if (!empty($CFG->gradepublishing)) {
     $CFG->gradepublishing = has_capability('gradeexport/xls:publish', $context);
@@ -42,8 +44,8 @@ $mform = new grade_export_form(null, array('publishing' => true));
 $groupmode    = groups_get_course_groupmode($course);   // Groups are being used
 $currentgroup = groups_get_course_group($course, true);
 if ($groupmode == SEPARATEGROUPS and !$currentgroup and !has_capability('moodle/site:accessallgroups', $context)) {
-    print_heading(get_string("notingroup"));
-    print_footer($course);
+    echo $OUTPUT->heading(get_string("notingroup"));
+    echo $OUTPUT->footer();
     die;    
 }
 
@@ -55,7 +57,7 @@ if ($data = $mform->get_data()) {
     $export->process_form($data);
     $export->print_continue();
     $export->display_preview();
-    print_footer($course);
+    echo $OUTPUT->footer();
     exit;
 }
 
@@ -64,5 +66,5 @@ echo '<div class="clearer"></div>';
 
 $mform->display();
 
-print_footer();
-?>
+echo $OUTPUT->footer();
+
