diff --git a/mod/forum/index.php b/mod/forum/index.php
index d23a17f..93904f8 100644
--- a/mod/forum/index.php
+++ b/mod/forum/index.php
@@ -1,57 +1,84 @@
-<?php  // $Id$
-
-    require_once("../../config.php");
-    require_once("lib.php");
-    require_once("$CFG->libdir/rsslib.php");
-
-    $id = optional_param('id', 0, PARAM_INT);                   // Course id
-    $subscribe = optional_param('subscribe', null, PARAM_INT);  // Subscribe/Unsubscribe all forums
+<?php
+
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * @package mod-forum
+ * @copyright 1999 onwards Martin Dougiamas  {@link http://moodle.com}
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+require_once(dirname(__FILE__) . '/../../config.php');
+require_once($CFG->dirroot . '/course/lib.php');
+require_once($CFG->dirroot . '/mod/forum/lib.php');
+require_once($CFG->libdir . '/rsslib.php');
+
+$id = optional_param('id', 0, PARAM_INT);                   // Course id
+$subscribe = optional_param('subscribe', null, PARAM_INT);  // Subscribe/Unsubscribe all forums
+
+$url = new moodle_url('/mod/forum/index.php', array('id'=>$id));
+if ($subscribe !== null) {
+    require_sesskey();
+    $url->param('subscribe', $subscribe);
+}
+$PAGE->set_url($url);
 
-    if ($id) {
-        if (! $course = get_record('course', 'id', $id)) {
-            error("Course ID is incorrect");
-        }
-    } else {
-        if (! $course = get_site()) {
-            error("Could not find a top-level course!");
-        }
+if ($id) {
+    if (! $course = $DB->get_record('course', array('id' => $id))) {
+        print_error('invalidcourseid');
     }
+} else {
+    $course = get_site();
+}
 
-    require_course_login($course);
-    $coursecontext = get_context_instance(CONTEXT_COURSE, $course->id);
+require_course_login($course);
+$PAGE->set_pagelayout('incourse');
+$coursecontext = get_context_instance(CONTEXT_COURSE, $course->id);
 
 
-    unset($SESSION->fromdiscussion);
+unset($SESSION->fromdiscussion);
 
-    add_to_log($course->id, 'forum', 'view forums', "index.php?id=$course->id");
+add_to_log($course->id, 'forum', 'view forums', "index.php?id=$course->id");
 
-    $strforums       = get_string('forums', 'forum');
-    $strforum        = get_string('forum', 'forum');
-    $strdescription  = get_string('description');
-    $strdiscussions  = get_string('discussions', 'forum');
-    $strsubscribed   = get_string('subscribed', 'forum');
-    $strunreadposts  = get_string('unreadposts', 'forum');
-    $strtracking     = get_string('tracking', 'forum');
-    $strmarkallread  = get_string('markallread', 'forum');
-    $strtrackforum   = get_string('trackforum', 'forum');
-    $strnotrackforum = get_string('notrackforum', 'forum');
-    $strsubscribe    = get_string('subscribe', 'forum');
-    $strunsubscribe  = get_string('unsubscribe', 'forum');
-    $stryes          = get_string('yes');
-    $strno           = get_string('no');
-    $strrss          = get_string('rss');
-    $strweek         = get_string('week');
-    $strsection      = get_string('section');
+$strforums       = get_string('forums', 'forum');
+$strforum        = get_string('forum', 'forum');
+$strdescription  = get_string('description');
+$strdiscussions  = get_string('discussions', 'forum');
+$strsubscribed   = get_string('subscribed', 'forum');
+$strunreadposts  = get_string('unreadposts', 'forum');
+$strtracking     = get_string('tracking', 'forum');
+$strmarkallread  = get_string('markallread', 'forum');
+$strtrackforum   = get_string('trackforum', 'forum');
+$strnotrackforum = get_string('notrackforum', 'forum');
+$strsubscribe    = get_string('subscribe', 'forum');
+$strunsubscribe  = get_string('unsubscribe', 'forum');
+$stryes          = get_string('yes');
+$strno           = get_string('no');
+$strrss          = get_string('rss');
 
-    $searchform = forum_search_form($course);
+$searchform = forum_search_form($course);
 
 
-    // Start of the table for General Forums
+// Start of the table for General Forums
 
-    $generaltable->head  = array ($strforum, $strdescription, $strdiscussions);
-    $generaltable->align = array ('left', 'left', 'center');
+$generaltable = new html_table();
+$generaltable->head  = array ($strforum, $strdescription, $strdiscussions);
+$generaltable->align = array ('left', 'left', 'center');
 
-    if ($usetracking = forum_tp_can_track_forums()) {
+if ($usetracking = forum_tp_can_track_forums()) {
         $untracked = forum_tp_get_untracked_forums($USER->id, $course->id);
 
         $generaltable->head[] = $strunreadposts;
@@ -59,38 +86,43 @@
 
         $generaltable->head[] = $strtracking;
         $generaltable->align[] = 'center';
-    }
+}
 
-    $subscribed_forums = forum_get_subscribed_forums($course);
+$subscribed_forums = forum_get_subscribed_forums($course);
 
-    if ($can_subscribe = (!isguestuser() && has_capability('moodle/course:view', $coursecontext))) {
+$can_subscribe = is_enrolled($coursecontext);
+if ($can_subscribe) {
         $generaltable->head[] = $strsubscribed;
         $generaltable->align[] = 'center';
-    }
+}
 
-    if ($show_rss = (($can_subscribe || $course->id == SITEID) &&
+if ($show_rss = (($can_subscribe || $course->id == SITEID) &&
                      isset($CFG->enablerssfeeds) && isset($CFG->forum_enablerssfeeds) &&
                      $CFG->enablerssfeeds && $CFG->forum_enablerssfeeds)) {
         $generaltable->head[] = $strrss;
         $generaltable->align[] = 'center';
-    }
+}
+
+$usesections = course_format_uses_sections($course->format);
+$sections = get_all_sections($course->id);
 
+$table = new html_table();
 
-    // Parse and organise all the forums.  Most forums are course modules but
-    // some special ones are not.  These get placed in the general forums
-    // category with the forums in section 0.
+// Parse and organise all the forums.  Most forums are course modules but
+// some special ones are not.  These get placed in the general forums
+// category with the forums in section 0.
 
-    $forums = get_records('forum', 'course', $course->id);
+$forums = $DB->get_records('forum', array('course' => $course->id));
 
-    $generalforums  = array();
-    $learningforums = array();
-    $modinfo =& get_fast_modinfo($course);
+$generalforums  = array();
+$learningforums = array();
+$modinfo =& get_fast_modinfo($course);
 
-    if (!isset($modinfo->instances['forum'])) {
+if (!isset($modinfo->instances['forum'])) {
         $modinfo->instances['forum'] = array();
-    }
+}
 
-    foreach ($modinfo->instances['forum'] as $forumid=>$cm) {
+foreach ($modinfo->instances['forum'] as $forumid=>$cm) {
         if (!$cm->uservisible or !isset($forums[$forumid])) {
             continue;
         }
@@ -115,11 +147,10 @@
         } else {
             $learningforums[$forum->id] = $forum;
         }
-    }
+}
                                         
-    /// Do course wide subscribe/unsubscribe
-    if (!is_null($subscribe) and !isguestuser() and !isguest()) {
-        require_sesskey();
+/// Do course wide subscribe/unsubscribe
+if (!is_null($subscribe) and !isguestuser()) {
         foreach ($modinfo->instances['forum'] as $forumid=>$cm) {
             $forum = $forums[$forumid];
             $modcontext = get_context_instance(CONTEXT_MODULE, $cm->id); 
@@ -143,21 +174,19 @@
             }
         }
         $returnto = forum_go_back_to("index.php?id=$course->id");
+    $shortname = format_string($course->shortname, true, array('context' => get_context_instance(CONTEXT_COURSE, $course->id)));
         if ($subscribe) {
             add_to_log($course->id, 'forum', 'subscribeall', "index.php?id=$course->id", $course->id);
-            redirect($returnto, get_string('nowallsubscribed', 'forum', format_string($course->shortname)), 1);
+        redirect($returnto, get_string('nowallsubscribed', 'forum', $shortname), 1);
         } else {
             add_to_log($course->id, 'forum', 'unsubscribeall', "index.php?id=$course->id", $course->id);
-            redirect($returnto, get_string('nowallunsubscribed', 'forum', format_string($course->shortname)), 1);
+        redirect($returnto, get_string('nowallunsubscribed', 'forum', $shortname), 1);
         }
-    }
-
-    /// First, let's process the general forums and build up a display
+}
 
-    $introoptions = new object();
-    $introoptions->para = false;
+/// First, let's process the general forums and build up a display
 
-    if ($generalforums) {
+if ($generalforums) {
         foreach ($generalforums as $forum) {
             $cm      = $modinfo->instances['forum'][$forum->id];
             $context = get_context_instance(CONTEXT_MODULE, $cm->id);
@@ -175,7 +204,7 @@
                     } else if ($unread = forum_tp_count_forum_unread_posts($cm, $course)) {
                             $unreadlink = '<span class="unread"><a href="view.php?f='.$forum->id.'">'.$unread.'</a>';
                         $unreadlink .= '<a title="'.$strmarkallread.'" href="markposts.php?f='.
-                                       $forum->id.'&amp;mark=read"><img src="'.$CFG->pixpath.'/t/clear.gif" alt="'.$strmarkallread.'" /></a></span>';
+                                   $forum->id.'&amp;mark=read"><img src="'.$OUTPUT->pix_url('t/clear') . '" alt="'.$strmarkallread.'" /></a></span>';
                     } else {
                         $unreadlink = '<span class="read">0</span>';
                     }
@@ -184,17 +213,17 @@
                         $trackedlink = $stryes;
 
                     } else {
-                        $options = array('id'=>$forum->id);
+                    $aurl = new moodle_url('/mod/forum/settracking.php', array('id'=>$forum->id));
                         if (!isset($untracked[$forum->id])) {
-                            $trackedlink = print_single_button($CFG->wwwroot.'/mod/forum/settracking.php', $options, $stryes, 'post', '_self', true, $strnotrackforum);
+                        $trackedlink = $OUTPUT->single_button($aurl, $stryes, 'post', array('title'=>$strnotrackforum));
                         } else {
-                            $trackedlink = print_single_button($CFG->wwwroot.'/mod/forum/settracking.php', $options, $strno, 'post', '_self', true, $strtrackforum);
+                        $trackedlink = $OUTPUT->single_button($aurl, $strno, 'post', array('title'=>$strtrackforum));
                         }
                     }
                 }
             }
 
-            $forum->intro = shorten_text(trim(format_text($forum->intro, FORMAT_HTML, $introoptions)), $CFG->forum_shortpost);
+        $forum->intro = shorten_text(format_module_intro('forum', $forum, $cm->id), $CFG->forum_shortpost);
             $forumname = format_string($forum->name, true);;
 
             if ($cm->visible) {
@@ -224,14 +253,14 @@
             //If this forum has RSS activated, calculate it
             if ($show_rss) {
                 if ($forum->rsstype and $forum->rssarticles) {
-                    //Calculate the tolltip text
+                //Calculate the tooltip text
                     if ($forum->rsstype == 1) {
-                        $tooltiptext = get_string('rsssubscriberssdiscussions', 'forum', format_string($forum->name));
+                    $tooltiptext = get_string('rsssubscriberssdiscussions', 'forum');
                     } else {
-                        $tooltiptext = get_string('rsssubscriberssposts', 'forum', format_string($forum->name));
+                    $tooltiptext = get_string('rsssubscriberssposts', 'forum');
                     }
                     //Get html code for RSS link
-                    $row[] = rss_get_link($course->id, $USER->id, 'forum', $forum->id, $tooltiptext);
+                $row[] = rss_get_link($context->id, $USER->id, 'mod_forum', $forum->id, $tooltiptext);
                 } else {
                     $row[] = '&nbsp;';
                 }
@@ -239,42 +268,41 @@
 
             $generaltable->data[] = $row;
         }
-    }
+}
 
 
-    // Start of the table for Learning Forums
-    $learningtable->head  = array ($strforum, $strdescription, $strdiscussions);
-    $learningtable->align = array ('left', 'left', 'center');
+// Start of the table for Learning Forums
+$learningtable = new html_table();
+$learningtable->head  = array ($strforum, $strdescription, $strdiscussions);
+$learningtable->align = array ('left', 'left', 'center');
 
-    if ($usetracking) {
+if ($usetracking) {
         $learningtable->head[] = $strunreadposts;
         $learningtable->align[] = 'center';
 
         $learningtable->head[] = $strtracking;
         $learningtable->align[] = 'center';
-    }
+}
 
-    if ($can_subscribe) {
+if ($can_subscribe) {
         $learningtable->head[] = $strsubscribed;
         $learningtable->align[] = 'center';
-    }
+}
 
-    if ($show_rss = (($can_subscribe || $course->id == SITEID) &&
+if ($show_rss = (($can_subscribe || $course->id == SITEID) &&
                      isset($CFG->enablerssfeeds) && isset($CFG->forum_enablerssfeeds) &&
                      $CFG->enablerssfeeds && $CFG->forum_enablerssfeeds)) {
         $learningtable->head[] = $strrss;
         $learningtable->align[] = 'center';
-    }
+}
 
-    /// Now let's process the learning forums
+/// Now let's process the learning forums
 
-    if ($course->id != SITEID) {    // Only real courses have learning forums
+if ($course->id != SITEID) {    // Only real courses have learning forums
+    // 'format_.'$course->format only applicable when not SITEID (format_site is not a format)
+    $strsectionname  = get_string('sectionname', 'format_'.$course->format);
         // Add extra field for section number, at the front
-        if ($course->format == 'weeks' or $course->format == 'weekscss') {
-            array_unshift($learningtable->head, $strweek);
-        } else {
-            array_unshift($learningtable->head, $strsection);
-        }
+    array_unshift($learningtable->head, $strsectionname);
         array_unshift($learningtable->align, 'center');
 
 
@@ -297,7 +325,7 @@
                         } else if ($unread = forum_tp_count_forum_unread_posts($cm, $course)) {
                             $unreadlink = '<span class="unread"><a href="view.php?f='.$forum->id.'">'.$unread.'</a>';
                             $unreadlink .= '<a title="'.$strmarkallread.'" href="markposts.php?f='.
-                                           $forum->id.'&amp;mark=read"><img src="'.$CFG->pixpath.'/t/clear.gif" alt="'.$strmarkallread.'" /></a></span>';
+                                       $forum->id.'&amp;mark=read"><img src="'.$OUTPUT->pix_url('t/clear') . '" alt="'.$strmarkallread.'" /></a></span>';
                         } else {
                             $unreadlink = '<span class="read">0</span>';
                         }
@@ -306,21 +334,20 @@
                             $trackedlink = $stryes;
 
                         } else {
-                            $options = array('id'=>$forum->id);
+                        $aurl = new moodle_url('/mod/forum/settracking.php', array('id'=>$forum->id));
                             if (!isset($untracked[$forum->id])) {
-                                $trackedlink = print_single_button($CFG->wwwroot.'/mod/forum/settracking.php', $options, $stryes, 'post', '_self', true, $strnotrackforum);
+                            $trackedlink = $OUTPUT->single_button($aurl, $stryes, 'post', array('title'=>$strnotrackforum));
                             } else {
-                                $trackedlink = print_single_button($CFG->wwwroot.'/mod/forum/settracking.php', $options, $strno, 'post', '_self', true, $strtrackforum);
+                            $trackedlink = $OUTPUT->single_button($aurl, $strno, 'post', array('title'=>$strtrackforum));
                             }
                         }
                     }
                 }
 
-                $introoptions->para=false;
-                $forum->intro = shorten_text(trim(format_text($forum->intro, FORMAT_HTML, $introoptions)), $CFG->forum_shortpost);
+            $forum->intro = shorten_text(format_module_intro('forum', $forum, $cm->id), $CFG->forum_shortpost);
 
                 if ($cm->sectionnum != $currentsection) {
-                    $printsection = $cm->sectionnum;
+                $printsection = get_section_name($course, $sections[$cm->sectionnum]);
                     if ($currentsection) {
                         $learningtable->data[] = 'hr';
                     }
@@ -360,12 +387,12 @@
                     if ($forum->rsstype and $forum->rssarticles) {
                         //Calculate the tolltip text
                         if ($forum->rsstype == 1) {
-                            $tooltiptext = get_string('rsssubscriberssdiscussions', 'forum', format_string($forum->name));
+                        $tooltiptext = get_string('rsssubscriberssdiscussions', 'forum');
                         } else {
-                            $tooltiptext = get_string('rsssubscriberssposts', 'forum', format_string($forum->name));
+                        $tooltiptext = get_string('rsssubscriberssposts', 'forum');
                         }
                         //Get html code for RSS link
-                        $row[] = rss_get_link($course->id, $USER->id, 'forum', $forum->id, $tooltiptext);
+                    $row[] = rss_get_link($context->id, $USER->id, 'mod_forum', $forum->id, $tooltiptext);
                     } else {
                         $row[] = '&nbsp;';
                     }
@@ -374,38 +401,39 @@
                 $learningtable->data[] = $row;
             }
         }
-    }
+}
 
 
-    /// Output the page
-    $navlinks = array();
-    $navlinks[] = array('name' => $strforums, 'link' => '', 'type' => 'activity');
+/// Output the page
+$PAGE->navbar->add($strforums);
+$PAGE->set_title("$course->shortname: $strforums");
+$PAGE->set_heading($course->fullname);
+$PAGE->set_button($searchform);
+echo $OUTPUT->header();
 
-    print_header("$course->shortname: $strforums", $course->fullname,
-                    build_navigation($navlinks),
-                    "", "", true, $searchform, navmenu($course));
+if (!isguestuser() && isloggedin()) {
+    echo $OUTPUT->box_start('subscription');
+    echo html_writer::tag('div',
+        html_writer::link(new moodle_url('/mod/forum/index.php', array('id'=>$course->id, 'subscribe'=>1, 'sesskey'=>sesskey())),
+            get_string('allsubscribe', 'forum')),
+        array('class'=>'helplink'));
+    echo html_writer::tag('div',
+        html_writer::link(new moodle_url('/mod/forum/index.php', array('id'=>$course->id, 'subscribe'=>0, 'sesskey'=>sesskey())),
+            get_string('allunsubscribe', 'forum')),
+        array('class'=>'helplink'));
+    echo $OUTPUT->box_end();
+    echo $OUTPUT->box('&nbsp;', 'clearer');
+}
 
-    if (!isguest()) {
-        print_box_start('subscription');
-        echo '<span class="helplink">';
-        echo '<a href="index.php?id='.$course->id.'&amp;subscribe=1&amp;sesskey='.sesskey().'">'.get_string('allsubscribe', 'forum').'</a>';
-        echo '</span><br /><span class="helplink">';
-        echo '<a href="index.php?id='.$course->id.'&amp;subscribe=0&amp;sesskey='.sesskey().'">'.get_string('allunsubscribe', 'forum').'</a>';
-        echo '</span>';
-        print_box_end();
-        print_box('&nbsp;', 'clearer');
-    }
+if ($generalforums) {
+    echo $OUTPUT->heading(get_string('generalforums', 'forum'));
+    echo html_writer::table($generaltable);
+}
 
-    if ($generalforums) {
-        print_heading(get_string('generalforums', 'forum'));
-        print_table($generaltable);
-    }
-
-    if ($learningforums) {
-        print_heading(get_string('learningforums', 'forum'));
-        print_table($learningtable);
-    }
+if ($learningforums) {
+    echo $OUTPUT->heading(get_string('learningforums', 'forum'));
+    echo html_writer::table($learningtable);
+}
 
-    print_footer($course);
+echo $OUTPUT->footer();
 
-?>
