diff --git a/mod/glossary/showentry.php b/mod/glossary/showentry.php
index 74ff50e..8d5c75b 100644
--- a/mod/glossary/showentry.php
+++ b/mod/glossary/showentry.php
@@ -1,53 +1,56 @@
-<?php  // $Id$
-    require_once("../../config.php");
-    require_once("lib.php");
+<?php
 
-    $concept  = optional_param('concept', '', PARAM_CLEAN);
-    $courseid = optional_param('courseid', 0, PARAM_INT);
-    $eid      = optional_param('eid', 0, PARAM_INT); // glossary entry id
-    $displayformat = optional_param('displayformat',-1, PARAM_SAFEDIR);
+require_once('../../config.php');
+require_once('lib.php');
 
-    if ($CFG->forcelogin) {
+$concept  = optional_param('concept', '', PARAM_CLEAN);
+$courseid = optional_param('courseid', 0, PARAM_INT);
+$eid      = optional_param('eid', 0, PARAM_INT); // glossary entry id
+$displayformat = optional_param('displayformat',-1, PARAM_SAFEDIR);
+$popup = optional_param('popup',0, PARAM_INT);
+
+$url = new moodle_url('/mod/glossary/showentry.php');
+$url->param('concept', $concept);
+$url->param('courseid', $courseid);
+$url->param('eid', $eid);
+$url->param('displayformat', $displayformat);
+$PAGE->set_url($url);
+
+if ($CFG->forcelogin) {
         require_login();
-    }
+}
 
-    if ($eid) {
-        if (!$entry = get_record("glossary_entries", "id", $eid)) {
-            error('Invalid entry id');
-        }
-        if (!$glossary = get_record('glossary','id',$entry->glossaryid)) {
-            error('Invalid glossary id');
-        }
-        if (!$cm = get_coursemodule_from_instance("glossary", $glossary->id)) {
-            error("Could not determine which course module this belonged to!");
-        }
-        if (!$course = get_record("course", "id", $cm->course)) {
-            error('Invalid course id');
-        }
+if ($eid) {
+    $entry = $DB->get_record('glossary_entries', array('id'=>$eid), '*', MUST_EXIST);
+    $glossary = $DB->get_record('glossary', array('id'=>$entry->glossaryid), '*', MUST_EXIST);
+    $cm = get_coursemodule_from_instance('glossary', $glossary->id, 0, false, MUST_EXIST);
+    $course = $DB->get_record('course', array('id'=>$cm->course), '*', MUST_EXIST);
         require_course_login($course, true, $cm);
         $entry->glossaryname = $glossary->name;
         $entry->cmid = $cm->id;
         $entry->courseid = $cm->course;
         $entries = array($entry);
 
-    } else if ($concept) {
-        if (!$course = get_record("course", "id", $courseid)) {
-            error('Invalid course id');
-        }
+} else if ($concept) {
+    $course = $DB->get_record('course', array('id'=>$courseid), '*', MUST_EXIST);
         require_course_login($course);
         $entries = glossary_get_entries_search($concept, $courseid);
 
-    } else {
-        error('No valid entry specified');
-    }
+} else {
+    print_error('invalidelementid');
+}
+
+if ($popup) {
+    $PAGE->set_pagelayout('popup');
+} else {
+    $PAGE->set_pagelayout('course');
+}
 
-    if ($entries) {
+if ($entries) {
         foreach ($entries as $key => $entry) {
             // Need to get the course where the entry is,
             // in order to check for visibility/approve permissions there
-            if (!$entrycourse = get_record("course", "id", $entry->courseid)) {
-                error('Invalid entry course id');
-            }
+        $entrycourse = $DB->get_record('course', array('id' => $entry->courseid), '*', MUST_EXIST);
             $modinfo = get_fast_modinfo($entrycourse);
             // make sure the entry is visible
             if (empty($modinfo->cms[$entry->cmid]->uservisible)) {
@@ -62,35 +65,35 @@
                     continue;
                 }
             }
+        if (!$popup) {
             $entries[$key]->footer = "<p style=\"text-align:right\">&raquo;&nbsp;<a href=\"$CFG->wwwroot/mod/glossary/view.php?g=$entry->glossaryid\">".format_string($entry->glossaryname,true)."</a></p>";
-            add_to_log($entry->courseid, "glossary", "view entry", "showentry.php?eid=$entry->id", $entry->id, $entry->cmid);
         }
+        add_to_log($entry->courseid, 'glossary', 'view entry', "showentry.php?eid=$entry->id", $entry->id, $entry->cmid);
     }
+}
 
-    if (!empty($courseid)) {
-        $strglossaries = get_string("modulenameplural", "glossary");
-        $strsearch = get_string("search");
-
-        $CFG->framename = "newwindow";
-        $navlinks = array();
-        $navlinks[] = array('name' => $strglossaries, 'link' => '', 'type' => 'activity');
-        $navlinks[] = array('name' => $strsearch, 'link' => '', 'type' => 'title');
+if (!empty($courseid)) {
+    $strglossaries = get_string('modulenameplural', 'glossary');
+    $strsearch = get_string('search');
 
-        $navigation = build_navigation($navlinks);
+    $CFG->framename = 'newwindow';
 
-        print_header(strip_tags("$course->shortname: $strglossaries $strsearch"), $course->fullname, $navigation, "", "", true, "&nbsp;", "&nbsp;");
+    $PAGE->navbar->add($strglossaries);
+    $PAGE->navbar->add($strsearch);
+    $PAGE->set_title(strip_tags("$course->shortname: $strglossaries $strsearch"));
+    $PAGE->set_heading($course->fullname);
+    echo $OUTPUT->header();
+} else {
+    echo $OUTPUT->header();    // Needs to be something here to allow linking back to the whole glossary
+}
 
-    } else {
-        print_header();    // Needs to be something here to allow linking back to the whole glossary
-    }
-
-    if ($entries) {
+if ($entries) {
         glossary_print_dynaentry($courseid, $entries, $displayformat);
-    }
+}
 
-    close_window_button();
+if ($popup) {
+    echo $OUTPUT->close_window_button();
+}
 
 /// Show one reduced footer
-    print_footer('none');
-
-?>
+echo $OUTPUT->footer();
\ No newline at end of file
