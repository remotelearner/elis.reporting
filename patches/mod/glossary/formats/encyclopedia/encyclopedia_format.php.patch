diff --git a/mod/glossary/formats/encyclopedia/encyclopedia_format.php b/mod/glossary/formats/encyclopedia/encyclopedia_format.php
index 7d50b0e..60b5ba4 100644
--- a/mod/glossary/formats/encyclopedia/encyclopedia_format.php
+++ b/mod/glossary/formats/encyclopedia/encyclopedia_format.php
@@ -1,19 +1,18 @@
-<?php  // $Id$
+<?php
 
-function glossary_show_entry_encyclopedia($course, $cm, $glossary, $entry, $mode='',$hook='',$printicons=1,$ratings=NULL, $aliases=true) {
-    global $CFG, $USER;
+function glossary_show_entry_encyclopedia($course, $cm, $glossary, $entry, $mode='',$hook='',$printicons=1, $aliases=true) {
+    global $CFG, $USER, $DB, $OUTPUT;
 
 
-    $user = get_record('user', 'id', $entry->userid);
+    $user = $DB->get_record('user', array('id'=>$entry->userid));
     $strby = get_string('writtenby', 'glossary');
 
-    $return = false;
     if ($entry) {
         echo '<table class="glossarypost encyclopedia" cellspacing="0">';
         echo '<tr valign="top">';
         echo '<td class="left picture">';
         
-        print_user_picture($user, $course->id, $user->picture);
+        echo $OUTPUT->user_picture($user, array('courseid'=>$course->id));
     
         echo '</td>';
         echo '<th class="entryheader">';
@@ -22,6 +21,7 @@ function glossary_show_entry_encyclopedia($course, $cm, $glossary, $entry, $mode
         echo '</div>';
 
         $fullname = fullname($user);
+        $by = new stdClass();
         $by->name = '<a href="'.$CFG->wwwroot.'/user/view.php?id='.$user->id.'&amp;course='.$course->id.'">'.$fullname.'</a>';
         $by->date = userdate($entry->timemodified);
         echo '<span class="author">'.get_string('bynameondate', 'forum', $by).'</span>';
@@ -45,15 +45,15 @@ function glossary_show_entry_encyclopedia($course, $cm, $glossary, $entry, $mode
             } else {
                 $align = 'left';
             }
-            glossary_print_entry_attachment($entry,'',$align,false);
+            glossary_print_entry_attachment($entry, $cm, null,$align,false);
         }
-        glossary_print_entry_definition($entry);
+        glossary_print_entry_definition($entry, $glossary, $cm);
 
-        if ($printicons or $ratings or $aliases) {
+        if ($printicons or $aliases) {
             echo '</td></tr>';
             echo '<tr>';
             echo '<td colspan="2" class="entrylowersection">';
-            $return = glossary_print_entry_lower_section($course, $cm, $glossary, $entry,$mode,$hook,$printicons,$ratings, $aliases);
+            glossary_print_entry_lower_section($course, $cm, $glossary, $entry,$mode,$hook,$printicons,$aliases);
             echo ' ';
         }
         
@@ -65,11 +65,9 @@ function glossary_show_entry_encyclopedia($course, $cm, $glossary, $entry, $mode
         print_string('noentry', 'glossary');
         echo '</div>';
     }
-    
-    return $return;
 }
 
-function glossary_print_entry_encyclopedia($course, $cm, $glossary, $entry, $mode='', $hook='', $printicons=1, $ratings=NULL) {
+function glossary_print_entry_encyclopedia($course, $cm, $glossary, $entry, $mode='', $hook='', $printicons=1) {
 
     //The print view for this format is exactly the normal view, so we use it
 
@@ -78,8 +76,8 @@ function glossary_print_entry_encyclopedia($course, $cm, $glossary, $entry, $mod
 
     //Call to view function (without icons, ratings and aliases) and return its result
     
-    return glossary_show_entry_encyclopedia($course, $cm, $glossary, $entry, $mode, $hook, false, false, false);
+    return glossary_show_entry_encyclopedia($course, $cm, $glossary, $entry, $mode, $hook, false, false);
 
 }
 
-?>
+
