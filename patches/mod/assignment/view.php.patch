diff --git a/mod/assignment/view.php b/mod/assignment/view.php
index 495a719..2d80577 100644
--- a/mod/assignment/view.php
+++ b/mod/assignment/view.php
@@ -1,41 +1,51 @@
-<?php  // $Id$
+<?php
 
-    require_once("../../config.php");
-    require_once("lib.php");
+require_once("../../config.php");
+require_once("lib.php");
+require_once($CFG->libdir . '/completionlib.php');
+require_once($CFG->libdir . '/plagiarismlib.php');
  
-    $id = optional_param('id', 0, PARAM_INT);  // Course Module ID
-    $a  = optional_param('a', 0, PARAM_INT);   // Assignment ID
+$id = optional_param('id', 0, PARAM_INT);  // Course Module ID
+$a  = optional_param('a', 0, PARAM_INT);   // Assignment ID
 
-    if ($id) {
+$url = new moodle_url('/mod/assignment/view.php');
+if ($id) {
         if (! $cm = get_coursemodule_from_id('assignment', $id)) {
-            error("Course Module ID was incorrect");
+        print_error('invalidcoursemodule');
         }
 
-        if (! $assignment = get_record("assignment", "id", $cm->instance)) {
-            error("assignment ID was incorrect");
+    if (! $assignment = $DB->get_record("assignment", array("id"=>$cm->instance))) {
+        print_error('invalidid', 'assignment');
         }
 
-        if (! $course = get_record("course", "id", $assignment->course)) {
-            error("Course is misconfigured");
+    if (! $course = $DB->get_record("course", array("id"=>$assignment->course))) {
+        print_error('coursemisconf', 'assignment');
         }
-    } else {
-        if (!$assignment = get_record("assignment", "id", $a)) {
-            error("Course module is incorrect");
+    $url->param('id', $id);
+} else {
+    if (!$assignment = $DB->get_record("assignment", array("id"=>$a))) {
+        print_error('invalidid', 'assignment');
         }
-        if (! $course = get_record("course", "id", $assignment->course)) {
-            error("Course is misconfigured");
+    if (! $course = $DB->get_record("course", array("id"=>$assignment->course))) {
+        print_error('coursemisconf', 'assignment');
         }
         if (! $cm = get_coursemodule_from_instance("assignment", $assignment->id, $course->id)) {
-            error("Course Module ID was incorrect");
-        }
+        print_error('invalidcoursemodule');
     }
+    $url->param('a', $a);
+}
+
+$PAGE->set_url($url);
+require_login($course, true, $cm);
 
-    require_login($course, true, $cm);
+$PAGE->requires->js('/mod/assignment/assignment.js');
 
-    require ("$CFG->dirroot/mod/assignment/type/$assignment->assignmenttype/assignment.class.php");
-    $assignmentclass = "assignment_$assignment->assignmenttype";
-    $assignmentinstance = new $assignmentclass($cm->id, $assignment, $cm, $course);
+require ("$CFG->dirroot/mod/assignment/type/$assignment->assignmenttype/assignment.class.php");
+$assignmentclass = "assignment_$assignment->assignmenttype";
+$assignmentinstance = new $assignmentclass($cm->id, $assignment, $cm, $course);
 
-    $assignmentinstance->view();   // Actually display the assignment!
+/// Mark as viewed
+$completion=new completion_info($course);
+$completion->set_module_viewed($cm);
 
-?>
+$assignmentinstance->view();   // Actually display the assignment!
\ No newline at end of file
