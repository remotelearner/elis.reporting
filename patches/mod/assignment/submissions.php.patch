diff --git a/mod/assignment/submissions.php b/mod/assignment/submissions.php
index 79e0caf..2358465 100644
--- a/mod/assignment/submissions.php
+++ b/mod/assignment/submissions.php
@@ -1,45 +1,58 @@
-<?php  // $Id$
+<?php
 
-    require_once("../../config.php");
-    require_once("lib.php");
+require_once("../../config.php");
+require_once("lib.php");
+require_once($CFG->libdir.'/plagiarismlib.php');
 
-    $id   = optional_param('id', 0, PARAM_INT);          // Course module ID
-    $a    = optional_param('a', 0, PARAM_INT);           // Assignment ID
-    $mode = optional_param('mode', 'all', PARAM_ALPHA);  // What mode are we in?
+$id   = optional_param('id', 0, PARAM_INT);          // Course module ID
+$a    = optional_param('a', 0, PARAM_INT);           // Assignment ID
+$mode = optional_param('mode', 'all', PARAM_ALPHA);  // What mode are we in?
+$download = optional_param('download' , 'none', PARAM_ALPHA); //ZIP download asked for?
 
-    if ($id) {
+$url = new moodle_url('/mod/assignment/submissions.php');
+if ($id) {
         if (! $cm = get_coursemodule_from_id('assignment', $id)) {
-            error("Course Module ID was incorrect");
+        print_error('invalidcoursemodule');
         }
 
-        if (! $assignment = get_record("assignment", "id", $cm->instance)) {
-            error("assignment ID was incorrect");
+    if (! $assignment = $DB->get_record("assignment", array("id"=>$cm->instance))) {
+        print_error('invalidid', 'assignment');
         }
 
-        if (! $course = get_record("course", "id", $assignment->course)) {
-            error("Course is misconfigured");
+    if (! $course = $DB->get_record("course", array("id"=>$assignment->course))) {
+        print_error('coursemisconf', 'assignment');
         }
-    } else {
-        if (!$assignment = get_record("assignment", "id", $a)) {
-            error("Course module is incorrect");
+    $url->param('id', $id);
+} else {
+    if (!$assignment = $DB->get_record("assignment", array("id"=>$a))) {
+        print_error('invalidcoursemodule');
         }
-        if (! $course = get_record("course", "id", $assignment->course)) {
-            error("Course is misconfigured");
+    if (! $course = $DB->get_record("course", array("id"=>$assignment->course))) {
+        print_error('coursemisconf', 'assignment');
         }
         if (! $cm = get_coursemodule_from_instance("assignment", $assignment->id, $course->id)) {
-            error("Course Module ID was incorrect");
-        }
+        print_error('invalidcoursemodule');
     }
+    $url->param('a', $a);
+}
+
+if ($mode !== 'all') {
+    $url->param('mode', $mode);
+}
+$PAGE->set_url($url);
+require_login($course->id, false, $cm);
 
-    require_login($course->id, false, $cm);
+require_capability('mod/assignment:grade', get_context_instance(CONTEXT_MODULE, $cm->id));
 
-    require_capability('mod/assignment:grade', get_context_instance(CONTEXT_MODULE, $cm->id));
+$PAGE->requires->js('/mod/assignment/assignment.js');
 
 /// Load up the required assignment code
-    require($CFG->dirroot.'/mod/assignment/type/'.$assignment->assignmenttype.'/assignment.class.php');
-    $assignmentclass = 'assignment_'.$assignment->assignmenttype;
-    $assignmentinstance = new $assignmentclass($cm->id, $assignment, $cm, $course);
+require($CFG->dirroot.'/mod/assignment/type/'.$assignment->assignmenttype.'/assignment.class.php');
+$assignmentclass = 'assignment_'.$assignment->assignmenttype;
+$assignmentinstance = new $assignmentclass($cm->id, $assignment, $cm, $course);
 
+if($download == "zip") {
+    $assignmentinstance->download_submissions();
+} else {
     $assignmentinstance->submissions($mode);   // Display or process the submissions
-
-?>
+}
\ No newline at end of file
