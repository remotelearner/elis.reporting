diff --git a/mod/lesson/grade.php b/mod/lesson/grade.php
index 5cb7a2c..0142964 100644
--- a/mod/lesson/grade.php
+++ b/mod/lesson/grade.php
@@ -1,27 +1,47 @@
-<?php  // $Id$
-
-    require_once("../../config.php");
-
-    $id   = required_param('id', PARAM_INT);          // Course module ID
-
-    if (! $cm = get_coursemodule_from_id('lesson', $id)) {
-        error("Course Module ID was incorrect");
-    }
-
-    if (! $lesson = get_record("lesson", "id", $cm->instance)) {
-        error("lesson ID was incorrect");
-    }
-
-    if (! $course = get_record("course", "id", $lesson->course)) {
-        error("Course is misconfigured");
-    }
-
-    require_login($course->id, false, $cm);
-
-    if (has_capability('mod/lesson:edit', get_context_instance(CONTEXT_MODULE, $cm->id))) {
+<?php
+
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Grade.php
+ *
+ * @package    mod
+ * @subpackage lesson
+ * @copyright 1999 onwards Martin Dougiamas  {@link http://moodle.com}
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ **/
+
+/**
+ * Require config.php
+ */
+require_once("../../config.php");
+require_once($CFG->dirroot.'/mod/lesson/locallib.php');
+
+$id = required_param('id', PARAM_INT);
+
+$cm = get_coursemodule_from_id('lesson', $id, 0, false, MUST_EXIST);;
+$course = $DB->get_record('course', array('id' => $cm->course), '*', MUST_EXIST);
+$lesson = new lesson($DB->get_record('lesson', array('id' => $cm->instance), '*', MUST_EXIST));
+
+require_login($course, false, $cm);
+
+$PAGE->set_url('/mod/lesson/grade.php', array('id'=>$cm->id));
+
+if (has_capability('mod/lesson:edit', get_context_instance(CONTEXT_MODULE, $cm->id))) {
         redirect('report.php?id='.$cm->id);
-    } else {
+} else {
         redirect('view.php?id='.$cm->id);
-    }
-
-?>
+}
\ No newline at end of file
