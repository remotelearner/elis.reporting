diff --git a/mod/lesson/reformat.php b/mod/lesson/reformat.php
index e13bc76..7712341 100644
--- a/mod/lesson/reformat.php
+++ b/mod/lesson/reformat.php
@@ -1,24 +1,45 @@
-<?php // $Id$
+<?php
+
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
 /**
  * jjg7:8/9/2004
  *
- * @version $Id$
- * @license http://www.gnu.org/copyleft/gpl.html GNU Public License
- * @package lesson
+ * @package    mod
+ * @subpackage lesson
+ * @copyright  1999 onwards Martin Dougiamas  {@link http://moodle.com}
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or late
  **/
 
+defined('MOODLE_INTERNAL') || die();
+
 function removedoublecr($filename) {
 // This function will adjust a file in roughly Aiken style by replacing extra newlines with <br/> tags
 // so that instructors can have newlines wherever they like as long as the overall format is in Aiken
     
     $filearray = file($filename);
     /// Check for Macintosh OS line returns (ie file on one line), and fix
-    if (ereg("\r", $filearray[0]) AND !ereg("\n", $filearray[0])) {
+    if (preg_match("/\r/", $filearray[0]) AND !preg_match("/\n/", $filearray[0])) {
         $outfile = explode("\r", $filearray[0]);
     } else {
         $outfile = $filearray;
     }
     
+    $outarray = array();
+
     foreach ($outfile as $line) {
         // remove leading and trailing whitespace
         trim($line);
@@ -182,4 +203,4 @@ function importmodifiedaikenstyle($filename) {
         return false;
     }
 }    
-?>
+
