diff --git a/mod/survey/save.php b/mod/survey/save.php
index 64c8783..1ed6e79 100644
--- a/mod/survey/save.php
+++ b/mod/survey/save.php
@@ -1,4 +1,28 @@
-<?php // $Id$
+<?php
+
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * This file is responsible for saving the results of a users survey and displaying
+ * the final message.
+ *
+ * @package   mod-survey
+ * @copyright 1999 onwards Martin Dougiamas  {@link http://moodle.com}
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
 
     require_once('../../config.php');
     require_once('lib.php');
@@ -6,36 +30,37 @@
 
 // Make sure this is a legitimate posting
 
-    if (!$formdata = data_submitted("$CFG->wwwroot/mod/survey/view.php") or !confirm_sesskey()) {
-        error("You are not supposed to use this script like that.");
+    if (!$formdata = data_submitted() or !confirm_sesskey()) {
+        print_error('cannotcallscript');
     }
 
     $id = required_param('id', PARAM_INT);    // Course Module ID
 
     if (! $cm = get_coursemodule_from_id('survey', $id)) {
-        error("Course Module ID was incorrect");
+        print_error('invalidcoursemodule');
     }
 
-    if (! $course = get_record("course", "id", $cm->course)) {
-        error("Course is misconfigured");
+    if (! $course = $DB->get_record("course", array("id"=>$cm->course))) {
+        print_error('coursemisconf');
     }
 
+    $PAGE->set_url('/mod/survey/save.php', array('id'=>$id));
     require_login($course->id, false, $cm);
     
     $context = get_context_instance(CONTEXT_MODULE, $cm->id);
     require_capability('mod/survey:participate', $context);
     
-    if (! $survey = get_record("survey", "id", $cm->instance)) {
-        error("Survey ID was incorrect");
+    if (! $survey = $DB->get_record("survey", array("id"=>$cm->instance))) {
+        print_error('invalidsurveyid', 'survey');
     }
 
     add_to_log($course->id, "survey", "submit", "view.php?id=$cm->id", "$survey->id", "$cm->id");
 
     $strsurveysaved = get_string('surveysaved', 'survey');
 
-    $navigation = build_navigation('', $cm);
-    print_header_simple("$strsurveysaved", "", $navigation, "");
-
+    $PAGE->set_title($strsurveysaved);
+    $PAGE->set_heading($course->fullname);
+    echo $OUTPUT->header();
 
     if (survey_already_done($survey->id, $USER->id)) {
         notice(get_string("alreadysubmitted", "survey"), $_SERVER["HTTP_REFERER"]);
@@ -68,7 +93,8 @@
 
     $timenow = time();
     foreach ($answers as $key => $val) {
-
+        if ($key != 'sesskey') {
+            $newdata = new stdClass();
         $newdata->time = $timenow;
         $newdata->userid = $USER->id;
         $newdata->survey = $survey->id;
@@ -84,8 +110,7 @@
             $newdata->answer2 = "";
         }
 
-        if (! insert_record("survey_answers", $newdata)) {
-            error("Encountered a problem trying to store your results. Sorry.");
+            $DB->insert_record("survey_answers", $newdata);
         }
     }
 
@@ -96,4 +121,4 @@
     exit;
 
 
-?>
+
