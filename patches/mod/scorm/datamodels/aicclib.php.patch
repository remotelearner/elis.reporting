diff --git a/mod/scorm/datamodels/aicclib.php b/mod/scorm/datamodels/aicclib.php
index 8764bc8..daa2078 100644
--- a/mod/scorm/datamodels/aicclib.php
+++ b/mod/scorm/datamodels/aicclib.php
@@ -1,4 +1,5 @@
-<?php // $Id$
+<?php
+
 function scorm_add_time($a, $b) {
     $aes = explode(':',$a);
     $bes = explode(':',$b);
@@ -58,6 +59,7 @@ function scorm_add_time($a, $b) {
 */
 function scorm_get_aicc_columns($row,$mastername='system_id') {
     $tok = strtok(strtolower($row),"\",\n\r");
+    $result = new stdClass();
     $result->columns = array();
     $i=0;
     while ($tok) {
@@ -90,28 +92,41 @@ function scorm_forge_cols_regexp($columns,$remodule='(".*")?,') {
     return $regexp;
 }
 
-function scorm_parse_aicc($pkgdir,$scormid) {
+
+function scorm_parse_aicc($scorm) {
+    global $DB;
+
+    if (!isset($scorm->cmid)) {
+        $cm = get_coursemodule_from_instance('scorm', $scorm->id);
+        $scorm->cmid = $cm->id;
+    }
+    $context = get_context_instance(CONTEXT_MODULE, $scorm->cmid);
+
+    $fs = get_file_storage();
+
+    $files = $fs->get_area_files($context->id, 'mod_scorm', 'content', 0, '', false);
+
+
     $version = 'AICC';
     $ids = array();
     $courses = array();
     $extaiccfiles = array('crs','des','au','cst','ort','pre','cmp');
-    if ($handle = opendir($pkgdir)) {
-        while (($file = readdir($handle)) !== false) {
-            if ($file[0] != '.') {
-                $ext = substr($file,strrpos($file,'.'));
+
+    foreach ($files as $file) {
+        $filename = $file->get_filename();
+        $ext = substr($filename,strrpos($filename,'.'));
                 $extension = strtolower(substr($ext,1));
                 if (in_array($extension,$extaiccfiles)) {
-                    $id = strtolower(basename($file,$ext));
+            $id = strtolower(basename($filename,$ext));
                     $ids[$id]->$extension = $file;
                 }
             }
-        }
-        closedir($handle);
-    }
+
     foreach ($ids as $courseid => $id) {
         if (isset($id->crs)) {
-            if (is_file($pkgdir.'/'.$id->crs)) {
-                $rows = file($pkgdir.'/'.$id->crs);
+            $contents = $id->crs->get_content();
+            $rows = explode("\r\n", $contents);
+            if (is_array($rows)) {
                 foreach ($rows as $row) {
                     if (preg_match("/^(.+)=(.+)$/",$row,$matches)) {
                         switch (strtolower(trim($matches[1]))) {
@@ -130,7 +145,8 @@ function scorm_parse_aicc($pkgdir,$scormid) {
             }
         }
         if (isset($id->des)) {
-            $rows = file($pkgdir.'/'.$id->des);
+            $contents = $id->des->get_content();
+            $rows = explode("\r\n", $contents);
             $columns = scorm_get_aicc_columns($rows[0]);
             $regexp = scorm_forge_cols_regexp($columns->columns);
             for ($i=1;$i<count($rows);$i++) {
@@ -143,7 +159,8 @@ function scorm_parse_aicc($pkgdir,$scormid) {
             }
         }
         if (isset($id->au)) {
-            $rows = file($pkgdir.'/'.$id->au);
+            $contents = $id->au->get_content();
+            $rows = explode("\r\n", $contents);
             $columns = scorm_get_aicc_columns($rows[0]);
             $regexp = scorm_forge_cols_regexp($columns->columns);
             for ($i=1;$i<count($rows);$i++) {
@@ -156,7 +173,8 @@ function scorm_parse_aicc($pkgdir,$scormid) {
             }
         }
         if (isset($id->cst)) {
-            $rows = file($pkgdir.'/'.$id->cst);
+            $contents = $id->cst->get_content();
+            $rows = explode("\r\n", $contents);
             $columns = scorm_get_aicc_columns($rows[0],'block');
             $regexp = scorm_forge_cols_regexp($columns->columns,'(.+)?,');
             for ($i=1;$i<count($rows);$i++) {
@@ -170,7 +188,8 @@ function scorm_parse_aicc($pkgdir,$scormid) {
             }
         }
         if (isset($id->ort)) {
-            $rows = file($pkgdir.'/'.$id->ort);
+            $contents = $id->ort->get_content();
+            $rows = explode("\r\n", $contents);
             $columns = scorm_get_aicc_columns($rows[0],'course_element');
             $regexp = scorm_forge_cols_regexp($columns->columns,'(.+)?,');
             for ($i=1;$i<count($rows);$i++) {
@@ -184,7 +203,8 @@ function scorm_parse_aicc($pkgdir,$scormid) {
             }
         }
         if (isset($id->pre)) {
-            $rows = file($pkgdir.'/'.$id->pre);
+            $contents = $id->pre->get_content();
+            $rows = explode("\r\n", $contents);
             $columns = scorm_get_aicc_columns($rows[0],'structure_element');
             $regexp = scorm_forge_cols_regexp($columns->columns,'(.+),');
             for ($i=1;$i<count($rows);$i++) {
@@ -194,19 +214,20 @@ function scorm_parse_aicc($pkgdir,$scormid) {
             }
         }
         if (isset($id->cmp)) {
-            $rows = file($pkgdir.'/'.$id->cmp);
+            $contents = $id->cmp->get_content();
+            $rows = explode("\r\n", $contents);
         }
     }
     //print_r($courses);
 
-    $oldscoes = get_records('scorm_scoes','scorm',$scormid);
+    $oldscoes = $DB->get_records('scorm_scoes', array('scorm'=>$scorm->id));
 
     $launch = 0;
     if (isset($courses)) {
         foreach ($courses as $course) {
-            $sco = new object();
+            $sco = new stdClass();
             $sco->identifier = $course->id;
-            $sco->scorm = $scormid;
+            $sco->scorm = $scorm->id;
             $sco->organization = '';
             $sco->title = $course->title;
             $sco->parent = '/';
@@ -214,11 +235,13 @@ function scorm_parse_aicc($pkgdir,$scormid) {
             $sco->scormtype = '';
 
             //print_r($sco);
-            if (get_record('scorm_scoes','scorm',$scormid,'identifier',$sco->identifier)) {
-                $id = update_record('scorm_scoes',addslashes_recursive($sco));
+            if ($ss = $DB->get_record('scorm_scoes', array('scorm'=>$scorm->id,'identifier'=>$sco->identifier))) {
+                $id = $ss->id;
+                $sco->id = $id;
+                $DB->update_record('scorm_scoes',$sco);
                 unset($oldscoes[$id]);
             } else {
-                $id = insert_record('scorm_scoes',addslashes_recursive($sco));
+                $id = $DB->insert_record('scorm_scoes',$sco);
             }
 
             if ($launch == 0) {
@@ -228,7 +251,7 @@ function scorm_parse_aicc($pkgdir,$scormid) {
                 foreach($course->elements as $element) {
                     unset($sco);
                     $sco->identifier = $element->system_id;
-                    $sco->scorm = $scormid;
+                    $sco->scorm = $scorm->id;
                     $sco->organization = $course->id;
                     $sco->title = $element->title;
 
@@ -245,46 +268,45 @@ function scorm_parse_aicc($pkgdir,$scormid) {
                         $id = null;
                         if ($oldscoid = scorm_array_search('identifier',$sco->identifier,$oldscoes)) {
                             $sco->id = $oldscoid;
-                            if(update_record('scorm_scoes',addslashes_recursive($sco))) {
+                            $DB->update_record('scorm_scoes',$sco);
                                 $id = $oldscoid;
-                            }
-                            delete_records('scorm_scoes_data','scoid',$oldscoid);
+                            $DB->delete_records('scorm_scoes_data', array('scoid'=>$oldscoid));
                             unset($oldscoes[$oldscoid]);
                         } else {
-                            $id = insert_record('scorm_scoes',addslashes_recursive($sco));
+                            $id = $DB->insert_record('scorm_scoes',$sco);
                         }
                         if (!empty($id)) {
-                            unset($scodata);
+                            $scodata = new stdClass();
                             $scodata->scoid = $id;
                             if (isset($element->web_launch)) {
                                 $scodata->name = 'parameters';
                                 $scodata->value = $element->web_launch;
-                                $dataid = insert_record('scorm_scoes_data',addslashes_recursive($scodata));
+                                $dataid = $DB->insert_record('scorm_scoes_data',$scodata);
                             }
                             if (isset($element->prerequisites)) {
                                 $scodata->name = 'prerequisites';
                                 $scodata->value = $element->prerequisites;
-                                $dataid = insert_record('scorm_scoes_data',addslashes_recursive($scodata));
+                                $dataid = $DB->insert_record('scorm_scoes_data',$scodata);
                             }
                             if (isset($element->max_time_allowed)) {
                                 $scodata->name = 'max_time_allowed';
                                 $scodata->value = $element->max_time_allowed;
-                                $dataid = insert_record('scorm_scoes_data',addslashes_recursive($scodata));
+                                $dataid = $DB->insert_record('scorm_scoes_data',$scodata);
                             }
                             if (isset($element->time_limit_action)) {
                                 $scodata->name = 'time_limit_action';
                                 $scodata->value = $element->time_limit_action;
-                                $dataid = insert_record('scorm_scoes_data',addslashes_recursive($scodata));
+                                $dataid = $DB->insert_record('scorm_scoes_data',$scodata);
                             }
                             if (isset($element->mastery_score)) {
                                 $scodata->name = 'mastery_score';
                                 $scodata->value = $element->mastery_score;
-                                $dataid = insert_record('scorm_scoes_data',addslashes_recursive($scodata));
+                                $dataid = $DB->insert_record('scorm_scoes_data',$scodata);
                             }
                             if (isset($element->core_vendor)) {
                                 $scodata->name = 'datafromlms';
-                                $scodata->value = eregi_replace('<cr>', "\r\n", $element->core_vendor);
-                                $dataid = insert_record('scorm_scoes_data',addslashes_recursive($scodata));
+                                $scodata->value = preg_replace('/<cr>/i', "\r\n", $element->core_vendor);
+                                $dataid = $DB->insert_record('scorm_scoes_data',$scodata);
                             }
                         }
                         if ($launch==0) {
@@ -297,248 +319,14 @@ function scorm_parse_aicc($pkgdir,$scormid) {
     }
     if (!empty($oldscoes)) {
         foreach($oldscoes as $oldsco) {
-            delete_records('scorm_scoes','id',$oldsco->id);
-            delete_records('scorm_scoes_track','scoid',$oldsco->id);
-        }
-    }
-    set_field('scorm','version','AICC','id',$scormid);
-    return $launch;
-}
-
-function scorm_get_toc($user,$scorm,$liststyle,$currentorg='',$scoid='',$mode='normal',$attempt='',$play=false) {
-    global $CFG;
-
-    $strexpand = get_string('expcoll','scorm');
-    $modestr = '';
-    if ($mode == 'browse') {
-        $modestr = '&amp;mode='.$mode;
-    }
-    $scormpixdir = $CFG->modpixpath.'/scorm/pix';
-
-    $result = new stdClass();
-    $result->toc = "<ul id='s0' class='$liststyle'>\n";
-    $tocmenus = array();
-    $result->prerequisites = true;
-    $incomplete = false;
-
-    //
-    // Get the current organization infos
-    //
-    if (!empty($currentorg)) {
-        if (($organizationtitle = get_field('scorm_scoes','title','scorm',$scorm->id,'identifier',$currentorg)) != '') {
-            $result->toc .= "\t<li>$organizationtitle</li>\n";
-            $tocmenus[] = $organizationtitle;
-        }
-    }
-    //
-    // If not specified retrieve the last attempt number
-    //
-    if (empty($attempt)) {
-        $attempt = scorm_get_last_attempt($scorm->id, $user->id);
-    }
-    $result->attemptleft = $scorm->maxattempt - $attempt;
-    if ($scoes = scorm_get_scoes($scorm->id, $currentorg)){
-        //
-        // Retrieve user tracking data for each learning object
-        //
-        $usertracks = array();
-        foreach ($scoes as $sco) {
-            if (!empty($sco->launch)) {
-                if (empty($scoid)) {
-                    $scoid = $sco->id;
-                }
-                if ($usertrack = scorm_get_tracks($sco->id,$user->id,$attempt)) {
-                    if ($usertrack->status == '') {
-                        $usertrack->status = 'notattempted';
-                    }
-                    $usertracks[$sco->identifier] = $usertrack;
-                }
-            }
-        }
-
-        $level=0;
-        $sublist=1;
-        $previd = 0;
-        $nextid = 0;
-        $findnext = false;
-        $parents[$level]='/';
-
-        foreach ($scoes as $pos => $sco) {
-            $isvisible = false;
-            $sco->title = stripslashes($sco->title);
-            if (!isset($sco->isvisible) || (isset($sco->isvisible) && ($sco->isvisible == 'true'))) {
-                $isvisible = true;
-            }
-            if ($parents[$level]!=$sco->parent) {
-                if ($newlevel = array_search($sco->parent,$parents)) {
-                    for ($i=0; $i<($level-$newlevel); $i++) {
-                        $result->toc .= "\t\t</ul></li>\n";
-                    }
-                    $level = $newlevel;
-                } else {
-                    $i = $level;
-                    $closelist = '';
-                    while (($i > 0) && ($parents[$level] != $sco->parent)) {
-                        $closelist .= "\t\t</ul></li>\n";
-                        $i--;
-                    }
-                    if (($i == 0) && ($sco->parent != $currentorg)) {
-                        $style = '';
-                        if (isset($_COOKIE['hide:SCORMitem'.$sco->id])) {
-                            $style = ' style="display: none;"';
-                        }
-                        $result->toc .= "\t\t<li><ul id='s$sublist' class='$liststyle'$style>\n";
-                        $level++;
-                    } else {
-                        $result->toc .= $closelist;
-                        $level = $i;
-                    }
-                    $parents[$level]=$sco->parent;
+            $DB->delete_records('scorm_scoes', array('id'=>$oldsco->id));
+            $DB->delete_records('scorm_scoes_track', array('scoid'=>$oldsco->id));
                 }
             }
-            if ($isvisible) {
-                $result->toc .= "\t\t<li>";
-            }
-            if (isset($scoes[$pos+1])) {
-                $nextsco = $scoes[$pos+1];
-            } else {
-                $nextsco = false;
-            }
-            $nextisvisible = false;
-            if (!isset($nextsco->isvisible) || (isset($nextsco->isvisible) && ($nextsco->isvisible == 'true'))) {
-                $nextisvisible = true;
-            }
-            if ($nextisvisible && ($nextsco !== false) && ($sco->parent != $nextsco->parent) && (($level==0) || (($level>0) && ($nextsco->parent == $sco->identifier)))) {
-                $sublist++;
-                $icon = 'minus';
-                if (isset($_COOKIE['hide:SCORMitem'.$nextsco->id])) {
-                    $icon = 'plus';
-                }
-                $result->toc .= '<a href="javascript:expandCollide(\'img'.$sublist.'\',\'s'.$sublist.'\','.$nextsco->id.');"><img id="img'.$sublist.'" src="'.$scormpixdir.'/'.$icon.'.gif" alt="'.$strexpand.'" title="'.$strexpand.'"/></a>';
-            } else if ($isvisible) {
-                $result->toc .= '<img src="'.$scormpixdir.'/spacer.gif" alt="" />';
-            }
-            if (empty($sco->title)) {
-                $sco->title = $sco->identifier;
-            }
-            if (!empty($sco->launch)) {
-                if ($isvisible) {
-                    $startbold = '';
-                    $endbold = '';
-                    $score = '';
-                    if (empty($scoid) && ($mode != 'normal')) {
-                        $scoid = $sco->id;
-                    }
-                    if (isset($usertracks[$sco->identifier])) {
-                        $usertrack = $usertracks[$sco->identifier];
-                        $strstatus = get_string($usertrack->status,'scorm');
-                        if ($sco->scormtype == 'sco') {
-                            $statusicon = '<img src="'.$scormpixdir.'/'.$usertrack->status.'.gif" alt="'.$strstatus.'" title="'.$strstatus.'" />';
-                        } else {
-                            $statusicon = '<img src="'.$scormpixdir.'/assetc.gif" alt="'.get_string('assetlaunched','scorm').'" title="'.get_string('assetlaunched','scorm').'" />';
-                        }
-
-                        if (($usertrack->status == 'notattempted') || ($usertrack->status == 'incomplete') || ($usertrack->status == 'browsed')) {
-                            $incomplete = true;
-                            if ($play && empty($scoid)) {
-                                $scoid = $sco->id;
-                            }
-                        }
-                        if ($usertrack->score_raw != '') {
-                            $score = '('.get_string('score','scorm').':&nbsp;'.$usertrack->score_raw.')';
-                        }
-                        $strsuspended = get_string('suspended','scorm');
-                        if ($incomplete && isset($usertrack->{'cmi.core.exit'}) && ($usertrack->{'cmi.core.exit'} == 'suspend')) {
-                            $statusicon = '<img src="'.$scormpixdir.'/suspend.gif" alt="'.$strstatus.' - '.$strsuspended.'" title="'.$strstatus.' - '.$strsuspended.'" />';
-                        }
-                    } else {
-                        if ($play && empty($scoid)) {
-                            $scoid = $sco->id;
-                        }
-                        $incomplete = true;
-                        if ($sco->scormtype == 'sco') {
-                            $statusicon = '<img src="'.$scormpixdir.'/notattempted.gif" alt="'.get_string('notattempted','scorm').'" title="'.get_string('notattempted','scorm').'" />';
-                        } else {
-                            $statusicon = '<img src="'.$scormpixdir.'/asset.gif" alt="'.get_string('asset','scorm').'" title="'.get_string('asset','scorm').'" />';
-                        }
-                    }
-                    if ($sco->id == $scoid) {
-                        $startbold = '<b>';
-                        $endbold = '</b>';
-                        $findnext = true;
-                        $shownext = isset($sco->next) ? $sco->next : 0;
-                        $showprev = isset($sco->previous) ? $sco->previous : 0;
-                    }
-
-                    if (($nextid == 0) && (scorm_count_launchable($scorm->id,$currentorg) > 1) && ($nextsco!==false) && (!$findnext)) {
-                        if (!empty($sco->launch)) {
-                            $previd = $sco->id;
-                        }
-                    }
-                    if (empty($sco->prerequisites) || scorm_eval_prerequisites($sco->prerequisites,$usertracks)) {
-                        if ($sco->id == $scoid) {
-                            $result->prerequisites = true;
-                        }
-                        $url = $CFG->wwwroot.'/mod/scorm/player.php?a='.$scorm->id.'&amp;currentorg='.$currentorg.$modestr.'&amp;scoid='.$sco->id;
-                        $result->toc .= $statusicon.'&nbsp;'.$startbold.'<a href="'.$url.'">'.format_string($sco->title).'</a>'.$score.$endbold."</li>\n";
-                        $tocmenus[$sco->id] = scorm_repeater('&minus;',$level) . '&gt;' . format_string($sco->title);
-                    } else {
-                        if ($sco->id == $scoid) {
-                            $result->prerequisites = false;
-                        }
-                        $result->toc .= $statusicon.'&nbsp;'.format_string($sco->title)."</li>\n";
-                    }
-                }
-            } else {
-                $result->toc .= '&nbsp;'.format_string($sco->title)."</li>\n";
-            }
-            if (($nextsco !== false) && ($nextid == 0) && ($findnext)) {
-                if (!empty($nextsco->launch)) {
-                    $nextid = $nextsco->id;
-                }
-            }
-        }
-        for ($i=0;$i<$level;$i++) {
-            $result->toc .= "\t\t</ul></li>\n";
-        }
 
-        if ($play) {
-            $sco = scorm_get_sco($scoid);
-            $sco->previd = $previd;
-            $sco->nextid = $nextid;
-            $result->sco = $sco;
-            $result->incomplete = $incomplete;
-        } else {
-            $result->incomplete = $incomplete;
-        }
-    }
-    $result->toc .= "\t</ul>\n";
-    if ($scorm->hidetoc == 0) {
-        $result->toc .= '
-          <script type="text/javascript">
-          //<![CDATA[
-              function expandCollide(which,list,item) {
-                  var el = document.ids ? document.ids[list] : document.getElementById ? document.getElementById(list) : document.all[list];
-                  which = which.substring(0,(which.length));
-                  var el2 = document.ids ? document.ids[which] : document.getElementById ? document.getElementById(which) : document.all[which];
-                  if (el.style.display != "none") {
-                      el2.src = "'.$scormpixdir.'/plus.gif";
-                      el.style.display=\'none\';
-                      new cookie("hide:SCORMitem" + item, 1, 356, "/").set();
-                  } else {
-                      el2.src = "'.$scormpixdir.'/minus.gif";
-                      el.style.display=\'block\';
-                      new cookie("hide:SCORMitem" + item, 1, -1, "/").set();
-                  }
-              }
-          //]]>
-          </script>'."\n";
-    }
+    $scorm->version = 'AICC';
 
-    $url = $CFG->wwwroot.'/mod/scorm/player.php?a='.$scorm->id.'&amp;currentorg='.$currentorg.$modestr.'&amp;scoid=';
-    $result->tocmenu = popup_form($url,$tocmenus, "tocmenu", $sco->id, '', '', '', true);
+    $scorm->launch = $launch;
 
-    return $result;
+    return true;
 }
-
-?>
