diff --git a/course/report/stats/index.php b/course/report/stats/index.php
index 7fb0f3e..6af3bc7 100644
--- a/course/report/stats/index.php
+++ b/course/report/stats/index.php
@@ -1,4 +1,4 @@
-<?php  // $Id$
+<?php
 
     require_once('../../../config.php');
     require_once($CFG->dirroot.'/lib/statslib.php');
@@ -25,52 +25,53 @@
         redirect($CFG->wwwroot.'/course/report/stats/index.php?time='.$time);
     }
 
-    if (!$course = get_record("course","id",$courseid)) {
-        error("That's an invalid course id");
+    if (!$course = $DB->get_record("course", array("id"=>$courseid))) {
+        print_error("invalidcourseid");
     }
 
     if (!empty($userid)) {
-        if (!$user = get_record('user','id',$userid)) {
-            error("That's an invalid user id");
+        if (!$user = $DB->get_record('user', array('id'=>$userid))) {
+            print_error("nousers");
         }
     }
 
     require_login($course);
     $context = get_context_instance(CONTEXT_COURSE, $course->id);
-
     require_capability('coursereport/stats:view', $context);
 
+    $PAGE->set_url(new moodle_url('/course/report/stats/index.php', array('course' => $course->id,
+                                                                          'report' => $report,
+                                                                          'time'   => $time,
+                                                                          'mode'   => $mode,
+                                                                          'userid' => $userid)));
+
     add_to_log($course->id, "course", "report stats", "report/stats/index.php?course=$course->id", $course->id);
     stats_check_uptodate($course->id);
 
     if ($course->id == SITEID) {
         admin_externalpage_setup('reportstats');
-        admin_externalpage_print_header();
-
+        echo $OUTPUT->header();
     } else {
         $strreports = get_string("reports");
         $strstats = get_string('stats');
 
-        $menu = report_stats_mode_menu($course, $mode, $time, "$CFG->wwwroot/course/report/stats/index.php");
-
-        $navlinks = array();
-        $navlinks[] = array('name' => $strreports, 'link' => "$CFG->wwwroot/course/report.php?id=$course->id", 'type' => 'misc');
-        $navlinks[] = array('name' => $strstats, 'link' => null, 'type' => 'misc');
-        $navigation = build_navigation($navlinks);
-
-        print_header("$course->shortname: $strstats", $course->fullname, $navigation, '', '', true, '&nbsp;', $menu);
+        $PAGE->set_title("$course->shortname: $strstats");
+        $PAGE->set_heading($course->fullname);
+        $PAGE->set_pagelayout('report');
+        $PAGE->set_headingmenu(report_stats_mode_menu($course, $mode, $time, "$CFG->wwwroot/course/report/stats/index.php"));
+        echo $OUTPUT->header();
     }
 
+    require($CFG->dirroot.'/course/report/stats/report.php');
+
     if (empty($CFG->enablestats)) {
         if (has_capability('moodle/site:config', get_context_instance(CONTEXT_SYSTEM))) {
             redirect("$CFG->wwwroot/$CFG->admin/settings.php?section=stats", get_string('mustenablestats', 'admin'), 3);
         } else {
-            error("Stats is not enabled.");
+            print_error('statsdisable');
         }
     }
 
-    require($CFG->dirroot.'/course/report/stats/report.php');
+    echo $OUTPUT->footer();
 
-    print_footer();
 
-?>
