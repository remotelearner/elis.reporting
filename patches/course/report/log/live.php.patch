diff --git a/course/report/log/live.php b/course/report/log/live.php
index f4a8fba..f3db876 100644
--- a/course/report/log/live.php
+++ b/course/report/log/live.php
@@ -1,4 +1,4 @@
-<?php // $Id$
+<?php
       //  Displays live view of recent logs
 
     require_once("../../../config.php");
@@ -7,8 +7,8 @@
     $id   = required_param('id', PARAM_INT);
     $page = optional_param('page', 0, PARAM_INT);     // which page to show
 
-    if (! $course = get_record("course", "id", $id) ) {
-        error("That's an invalid course id");
+    if (! $course = $DB->get_record("course", array("id"=>$id))) {
+        print_error('invalidcourseid');
     }
 
     require_login($course);
@@ -18,7 +18,7 @@
 
     add_to_log($course->id, "course", "report live", "report/log/live.php?id=$course->id", $course->id); 
 
-    session_write_close();
+    session_get_instance()->write_close();
 
     // we override the default framename so header/footer
     // links open in a new window 
@@ -29,8 +29,12 @@
     $strlivelogs = get_string("livelogs");
     $strupdatesevery = get_string("updatesevery", "moodle", COURSE_LIVELOG_REFRESH);
 
-    print_header("$strlivelogs ($strupdatesevery)", "$strlivelogs", "", "", 
-                 '<meta http-equiv="Refresh" content="'.COURSE_LIVELOG_REFRESH.'; url=live.php?id='.$course->id.'" />');
+    $PAGE->set_url('/course/report/log/live.php', array('id'=>$course->id));
+    $PAGE->set_pagelayout('popup');
+    $PAGE->set_title("$strlivelogs ($strupdatesevery)");
+    $PAGE->set_periodic_refresh_delay(COURSE_LIVELOG_REFRESH);
+    $PAGE->set_heading($strlivelogs);
+    echo $OUTPUT->header();
 
     $user=0;
     $date=time() - 3600;
@@ -38,8 +42,8 @@
     print_log($course, $user, $date, "l.time DESC", $page, 500,
               "live.php?id=$course->id&amp;user=$user&amp;date=$date");
 
-    print_footer('none');
+    echo $OUTPUT->footer();
 
     exit;
 
-?>
+
