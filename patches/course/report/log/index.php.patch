diff --git a/course/report/log/index.php b/course/report/log/index.php
index 0b2cc58..df325b8 100644
--- a/course/report/log/index.php
+++ b/course/report/log/index.php
@@ -1,4 +1,4 @@
-<?php // $Id$
+<?php
       // Displays different views of the logs.
 
     require_once('../../../config.php');
@@ -23,7 +23,7 @@
     $group       = optional_param('group', 0, PARAM_INT); // Group to display
     $user        = optional_param('user', 0, PARAM_INT); // User to display
     $date        = optional_param('date', 0, PARAM_FILE); // Date to display - number or some string
-    $modname     = optional_param('modname', '', PARAM_CLEAN); // course_module->id
+    $modname     = optional_param('modname', '', PARAM_SAFEDIR); // course_module->id
     $modid       = optional_param('modid', 0, PARAM_FILE); // number or 'site_errors'
     $modaction   = optional_param('modaction', '', PARAM_PATH); // an action as recorded in the logs
     $page        = optional_param('page', '0', PARAM_INT);     // which page to show
@@ -33,18 +33,37 @@
     $chooselog   = optional_param('chooselog', 0, PARAM_INT);
     $logformat   = optional_param('logformat', 'showashtml', PARAM_ALPHA);
 
+    $params = array();
+    if ($id !== 0) $params['id'] = $id;
+    if ($host_course !== '') $params['host_course'] = $host_course;
+    if ($group !== 0) $params['group'] = $group;
+    if ($user !== 0) $params['user'] = $user;
+    if ($date !== 0) $params['date'] = $date;
+    if ($modname !== '') $params['modname'] = $modname;
+    if ($modid !== 0) $params['modid'] = $modid;
+    if ($modaction !== '') $params['modaction'] = $modaction;
+    if ($page !== '0') $params['page'] = $page;
+    if ($perpage !== '100') $params['perpage'] = $perpage;
+    if ($showcourses !== 0) $params['showcourses'] = $showcourses;
+    if ($showusers !== 0) $params['showusers'] = $showusers;
+    if ($chooselog !== 0) $params['chooselog'] = $chooselog;
+    if ($logformat !== 'showashtml') $params['logformat'] = $logformat;
+    $PAGE->set_url('/course/report/log/index.php', $params);
+    $PAGE->set_pagelayout('report');
+
     if ($hostid == $CFG->mnet_localhost_id) {
-        if (!$course = get_record('course', 'id', $id) ) {
-            error('That\'s an invalid course id'.$id);
+        if (!$course = $DB->get_record('course', array('id'=>$id))) {
+            print_error('That\'s an invalid course id'.$id);
         }
     } else {
-        $course_stub       = array_pop(get_records_select('mnet_log', " hostid='$hostid' AND course='$id' ", '', '*', '', '1'));
+        $course_stub       = $DB->get_record('mnet_log', array('hostid'=>$hostid, 'course'=>$id), '*', true);
         $course->id        = $id;
         $course->shortname = $course_stub->coursename;
         $course->fullname  = $course_stub->coursename;
     }
 
     require_login($course);
+
     $context = get_context_instance(CONTEXT_COURSE, $course->id);
 
     require_capability('coursereport/log:view', $context);
@@ -55,7 +74,7 @@
     $stradministration = get_string('administration');
     $strreports = get_string('reports');
 
-    session_write_close();
+    session_get_instance()->write_close();
 
     $navlinks = array();
 
@@ -64,8 +83,8 @@
         $dateinfo = get_string('alldays');
 
         if ($user) {
-            if (!$u = get_record('user', 'id', $user) ) {
-                error('That\'s an invalid user!');
+            if (!$u = $DB->get_record('user', array('id'=>$user))) {
+                print_error('That\'s an invalid user!');
             }
             $userinfo = fullname($u, has_capability('moodle/site:viewfullnames', $context));
         }
@@ -77,17 +96,18 @@
             case 'showashtml':
                 if ($hostid != $CFG->mnet_localhost_id || $course->id == SITEID) {
                     admin_externalpage_setup('reportlog');
-                    admin_externalpage_print_header();
+                    echo $OUTPUT->header();
 
                 } else {
-                    $navlinks[] = array('name' => $strreports, 'link' => "$CFG->wwwroot/course/report.php?id=$course->id", 'type' => 'misc');
-                    $navlinks[] = array('name' => $strlogs, 'link' => "index.php?id=$course->id", 'type' => 'misc');
-                    $navlinks[] = array('name' => "$userinfo, $dateinfo", 'link' => null, 'type' => 'misc');
-                    $navigation = build_navigation($navlinks);
-                    print_header($course->shortname .': '. $strlogs, $course->fullname, $navigation);
+                    $PAGE->set_title($course->shortname .': '. $strlogs);
+                    $PAGE->set_heading($course->fullname);
+                    $PAGE->navbar->add($strreports, new moodle_url('/course/report.php', array('id'=>$course->id)));
+                    $PAGE->navbar->add($strlogs, new moodle_url('/course/report/log/index.php', array('id'=>$course->id)));
+                    $PAGE->navbar->add("$userinfo, $dateinfo");
+                    echo $OUTPUT->header();
                 }
 
-                print_heading(format_string($course->fullname) . ": $userinfo, $dateinfo (".usertimezone().")");
+                echo $OUTPUT->heading(format_string($course->fullname) . ": $userinfo, $dateinfo (".usertimezone().")");
                 print_mnet_log_selector_form($hostid, $course, $user, $date, $modname, $modid, $modaction, $group, $showcourses, $showusers, $logformat);
 
                 if($hostid == $CFG->mnet_localhost_id) {
@@ -101,22 +121,22 @@
             case 'downloadascsv':
                 if (!print_log_csv($course, $user, $date, 'l.time DESC', $modname,
                         $modid, $modaction, $group)) {
-                    notify("No logs found!");
-                    print_footer($course);
+                    echo $OUTPUT->notification("No logs found!");
+                    echo $OUTPUT->footer();
                 }
                 exit;
             case 'downloadasods':
                 if (!print_log_ods($course, $user, $date, 'l.time DESC', $modname,
                         $modid, $modaction, $group)) {
-                    notify("No logs found!");
-                    print_footer($course);
+                    echo $OUTPUT->notification("No logs found!");
+                    echo $OUTPUT->footer();
                 }
                 exit;
             case 'downloadasexcel':
                 if (!print_log_xls($course, $user, $date, 'l.time DESC', $modname,
                         $modid, $modaction, $group)) {
-                    notify("No logs found!");
-                    print_footer($course);
+                    echo $OUTPUT->notification("No logs found!");
+                    echo $OUTPUT->footer();
                 }
                 exit;
         }
@@ -125,20 +145,25 @@
     } else {
         if ($hostid != $CFG->mnet_localhost_id || $course->id == SITEID) {
                     admin_externalpage_setup('reportlog');
-                    admin_externalpage_print_header();
+            echo $OUTPUT->header();
         } else {
-            $navlinks[] = array('name' => $strreports, 'link' => "$CFG->wwwroot/course/report.php?id=$course->id", 'type' => 'misc');
-            $navlinks[] = array('name' => $strlogs, 'link' => null, 'type' => 'misc');
-            $navigation = build_navigation($navlinks);
-            print_header($course->shortname .': '. $strlogs, $course->fullname, $navigation, '');
+            $PAGE->set_title($course->shortname .': '. $strlogs);
+            $PAGE->set_heading($course->fullname);
+            echo $OUTPUT->header();
         }
 
-        print_heading(get_string('chooselogs') .':');
+        echo $OUTPUT->heading(get_string('chooselogs') .':');
 
         print_log_selector_form($course, $user, $date, $modname, $modid, $modaction, $group, $showcourses, $showusers, $logformat);
+
+        $livelogs = get_string('livelogs');
+        $url = new moodle_url('/course/report/log/live.php', array('id'=>$course->id));
+        $link = new action_link($url, $livelogs, new popup_action('click', $url, 'livelog', array('height' => 500, 'width' => 800)));
+
+        echo $OUTPUT->render($link);
     }
 
-    print_footer($course);
+    echo $OUTPUT->footer();
 
     exit;
-?>
+
