diff --git a/course/editcategory_form.php b/course/editcategory_form.php
index 24f40f2..e5f1f27 100644
--- a/course/editcategory_form.php
+++ b/course/editcategory_form.php
@@ -1,12 +1,17 @@
 <?php 
+if (!defined('MOODLE_INTERNAL')) {
+    die('Direct access to this script is forbidden.');    ///  It must be included from a Moodle page
+}
+
 require_once ($CFG->dirroot.'/course/moodleform_mod.php');
 class editcategory_form extends moodleform {
 
     // form definition
     function definition() {
-        global $CFG;
+        global $CFG, $DB;
         $mform =& $this->_form;
-        $category = $this->_customdata;
+        $category = $this->_customdata['category'];
+        $editoroptions = $this->_customdata['editoroptions'];
 
         // get list of categories to use as parents, with site as the first one
         $options = array();
@@ -18,7 +23,7 @@ class editcategory_form extends moodleform {
             // Editing an existing category.
             make_categories_list($options, $parents, 'moodle/category:manage', $category->id);
             if (empty($options[$category->parent])) {
-               $options[$category->parent] = get_field('course_categories', 'name', 'id', $category->parent);
+                $options[$category->parent] = $DB->get_field('course_categories', 'name', array('id'=>$category->parent));
             }
             $strsubmit = get_string('savechanges');
         } else {
@@ -30,15 +35,18 @@ class editcategory_form extends moodleform {
         $mform->addElement('select', 'parent', get_string('parentcategory'), $options);
         $mform->addElement('text', 'name', get_string('categoryname'), array('size'=>'30'));
         $mform->addRule('name', get_string('required'), 'required', null);
-        $mform->addElement('htmleditor', 'description', get_string('description'));
-        $mform->setType('description', PARAM_RAW);
+        $mform->addElement('editor', 'description_editor', get_string('description'), null, $editoroptions);
+        $mform->setType('description_editor', PARAM_RAW);
         if (!empty($CFG->allowcategorythemes)) {
-            $themes=array();
-            $themes[''] = get_string('forceno');
-            $themes += get_list_of_themes();
+            $themes = array(''=>get_string('forceno'));
+            $allthemes = get_list_of_themes();
+            foreach ($allthemes as $key=>$theme) {
+                if (empty($theme->hidefromselector)) {
+                    $themes[$key] = $theme->name;
+                }
+            }
             $mform->addElement('select', 'theme', get_string('forcetheme'), $themes);
         }
-        $mform->setHelpButton('description', array('writing', 'richtext'), false, 'editorhelpbutton');
 
         $mform->addElement('hidden', 'id', 0);
         $mform->setType('id', PARAM_INT);
@@ -47,4 +55,4 @@ class editcategory_form extends moodleform {
         $this->add_action_buttons(true, $strsubmit);
     }
 } 
-?>
+
