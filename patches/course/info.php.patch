diff --git a/course/info.php b/course/info.php
index b376798..aca5105 100644
--- a/course/info.php
+++ b/course/info.php
@@ -1,4 +1,4 @@
-<?php // $Id$
+<?php
 
 /// Displays external information about a course
 
@@ -9,16 +9,16 @@
     $name = optional_param('name', false, PARAM_RAW); // Course short name
 
     if (!$id and !$name) {
-        error("Must specify course id or short name");
+        print_error("unspecifycourseid");
     }
 
     if ($name) {
-        if (! $course = get_record("course", "shortname", $name) ) {
-            error("That's an invalid short course name");
+        if (!$course = $DB->get_record("course", array("shortname"=>$name))) {
+            print_error("invalidshortname");
         }
     } else {
-        if (! $course = get_record("course", "id", $id) ) {
-            error("That's an invalid course id");
+        if (!$course = $DB->get_record("course", array("id"=>$id))) {
+            print_error("invalidcourseid");
         }
     }
 
@@ -29,40 +29,39 @@
     }
     
     $context = get_context_instance(CONTEXT_COURSE, $course->id); 
-    if ((!course_parent_visible($course) || (! $course->visible)) && !has_capability('moodle/course:viewhiddencourses', $context)) {
+    if (!$course->visible and !has_capability('moodle/course:viewhiddencourses', $context)) {
         print_error('coursehidden', '', $CFG->wwwroot .'/'); 
     }  
     
-    print_header(get_string("summaryof", "", $course->fullname));
-
-    print_heading(format_string($course->fullname) . '<br />(' . format_string($course->shortname) . ')');
-
-    if ($course->guest || $course->password) {
-        print_box_start('generalbox icons');
-        if ($course->guest) {
-            $strallowguests = get_string('allowguests');
-            echo "<div><img alt=\"\" class=\"icon guest\" src=\"$CFG->pixpath/i/guest.gif\" />&nbsp;$strallowguests</div>";
-        }
-        if ($course->password) {
-            $strrequireskey = get_string('requireskey');
-            echo "<div><img alt=\"\" class=\"icon key\" src=\"$CFG->pixpath/i/key.gif\" />&nbsp;$strrequireskey</div>";
+    $PAGE->set_context($context);
+    $PAGE->set_pagelayout('popup');
+    $PAGE->set_url('/course/info.php', array('id' => $course->id));
+    $PAGE->set_title(get_string("summaryof", "", $course->fullname));
+    $PAGE->set_heading('Course info');
+    $PAGE->set_course($course);
+    $PAGE->navbar->add(get_string('summary'));
+
+    echo $OUTPUT->header();
+    echo $OUTPUT->heading('<a href="view.php?id='.$course->id.'">'.format_string($course->fullname) . '</a><br />(' . format_string($course->shortname, true, array('context' => $context)) . ')');
+
+    // print enrol info
+    if ($texts = enrol_get_course_description_texts($course)) {
+        echo $OUTPUT->box_start('generalbox icons');
+        echo implode($texts);
+        echo $OUTPUT->box_end();
         }
-        print_box_end();
-    }
-
-
-    print_box_start('generalbox info');
 
-    echo filter_text(text_to_html($course->summary),$course->id);
+    echo $OUTPUT->box_start('generalbox info');
 
+    $course->summary = file_rewrite_pluginfile_urls($course->summary, 'pluginfile.php', $context->id, 'course', 'summary', NULL);
+    echo format_text($course->summary, $course->summaryformat, array('overflowdiv'=>true), $course->id);
     
-    if ($managerroles = get_config('', 'coursemanager')) {
-        $coursemanagerroles = split(',', $managerroles);
-        foreach ($coursemanagerroles as $roleid) {
-            $role = get_record('role','id',$roleid);
-            $canseehidden = has_capability('moodle/role:viewhiddenassigns', $context);
+    if (!empty($CFG->coursecontact)) {
+        $coursecontactroles = explode(',', $CFG->coursecontact);
+        foreach ($coursecontactroles as $roleid) {
+            $role = $DB->get_record('role', array('id'=>$roleid));
             $roleid = (int) $roleid;
-            if ($users = get_role_users($roleid, $context, true, '', 'u.lastname ASC', $canseehidden)) {
+            if ($users = get_role_users($roleid, $context, true)) {
                 foreach ($users as $teacher) {
                     $fullname = fullname($teacher, has_capability('moodle/site:viewfullnames', $context)); 
                     $namesarray[] = format_string(role_get_name($role, $context)).': <a href="'.$CFG->wwwroot.'/user/view.php?id='.
@@ -78,16 +77,12 @@
         }
     }
 
-    require_once("$CFG->dirroot/enrol/enrol.class.php");
-    $enrol = enrolment_factory::factory($course->enrol);
-    echo $enrol->get_access_icons($course);
+// TODO: print some enrol icons
 
-    print_box_end();
+    echo $OUTPUT->box_end();
 
     echo "<br />";
 
-    close_window_button();
+    echo $OUTPUT->footer();
 
-    print_footer();
 
-?>
