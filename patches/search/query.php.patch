diff --git a/search/query.php b/search/query.php
index ccca0d2..bb49199 100644
--- a/search/query.php
+++ b/search/query.php
@@ -35,19 +35,28 @@
     * includes and requires
     */
     require_once('../config.php');
-    require_once("$CFG->dirroot/search/lib.php");
-    // include "debugging.php";
+    require_once($CFG->dirroot.'/search/lib.php');
 
+    $block_instanceid = required_param('block_instanceid', PARAM_INT);// Block Instance ID
 
     if ($CFG->forcelogin) {
         require_login();
     }
     
     if (empty($CFG->enableglobalsearch)) {
-        error(get_string('globalsearchdisabled', 'search'));
+        print_error('globalsearchdisabled', 'search');
     }
+    //Check user's permissions against the block instance from which the user came
+    if (empty($block_instanceid)) {
+        print_error('searchnotpermitted', 'search');
+    }
+    if (!$DB->record_exists('block_instances', array('id' => $block_instanceid, 'blockname' => 'search'))) {
+        print_error('searchnotpermitted', 'search');
+    }
+    $contextblock = get_context_instance(CONTEXT_BLOCK, $block_instanceid);
+    require_capability('moodle/block:view', $contextblock);
     
-    $adv = new Object();
+    $adv = new stdClass();
     
 /// check for php5, but don't die yet (see line 52)
 
@@ -56,7 +65,17 @@
     $page_number  = optional_param('page', -1, PARAM_INT);
     $pages        = ($page_number == -1) ? false : true;
     $advanced     = (optional_param('a', '0', PARAM_INT) == '1') ? true : false;
-    $query_string = stripslashes(optional_param('query_string', '', PARAM_CLEAN));
+    $query_string = optional_param('query_string', '', PARAM_CLEAN);
+
+    $url = new moodle_url('/search/query.php');
+    if ($page_number !== -1) {
+        $url->param('page', $page_number);
+    }
+    if ($advanced) {
+        $url->param('a', '1');
+    }
+    $url->param('block_instanceid', $block_instanceid);
+    $PAGE->set_url($url);
 
 /// discard harmfull searches  
 
@@ -151,41 +170,36 @@
     Zend_Search_Lucene_Analysis_Analyzer::setDefault(new Zend_Search_Lucene_Analysis_Analyzer_Common_Utf8_CaseInsensitive());
     $sq = new SearchQuery($query_string, $page_number, 10, false);
     
-    if (!$site = get_site()) {
-        redirect("index.php");
-    } 
+    $site = get_site();
     
     $strsearch = get_string('search', 'search');
     $strquery  = get_string('enteryoursearchquery', 'search');
     
-//    if ($CFG->version < 2007032200){ NOT RELIABLE
-    if (!function_exists('build_navigation')){
-        print_header("$site->shortname: $strsearch: $strquery", "$site->fullname",
-               "<a href=\"index.php\">$strsearch</a> -> $strquery");
-    } else {
-        $navlinks[] = array('name' => $strsearch, 'link' => "index.php", 'type' => 'misc');
-        $navlinks[] = array('name' => $strquery, 'link' => null, 'type' => 'misc');
-        $navigation = build_navigation($navlinks);
+    // print the header
         $site = get_site();
-        print_header("$strsearch", "$site->fullname" , $navigation, "", "", true, "&nbsp;", navmenu($site));
-    }
+    $PAGE->set_context(get_context_instance(CONTEXT_SYSTEM));
+    $PAGE->navbar->add($strsearch, new moodle_url('/search/query.php?block_instanceid=' . $block_instanceid));
+    $PAGE->navbar->add($strquery, new moodle_url('/search/stats.php?block_instanceid=' . $block_instanceid));
+    $PAGE->set_title($strsearch);
+    $PAGE->set_heading($site->fullname);
+    echo $OUTPUT->header();
     
     if (!empty($error)){
         notice ($error);
     }
     
-    print_box_start();
-    print_heading($strquery);
+    echo $OUTPUT->box_start();
+    echo $OUTPUT->heading($strquery);
     
-    print_box_start();
+    echo $OUTPUT->box_start();
     
     $vars = get_object_vars($adv);
     
     if (isset($vars)) {
         foreach ($vars as $key => $value) {
-            // htmlentities breaks non-ascii chars
-            $adv->key = stripslashes($value);
-            //$adv->$key = stripslashes(htmlentities($value));
+            // htmlentities breaks non-ascii chars ??
+            $adv->key = $value;
+            //$adv->$key = htmlentities($value);
         } 
     }
     ?>
@@ -193,16 +207,18 @@
     <?php 
     if (!$advanced) { 
     ?>
-        <input type="text" name="query_string" length="50" value="<?php p($query_string) ?>" />
-        &nbsp;<input type="submit" value="<?php print_string('search', 'search') ?>" /> &nbsp;
-        <a href="query.php?a=1"><?php print_string('advancedsearch', 'search') ?></a> |
-        <a href="stats.php"><?php print_string('statistics', 'search') ?></a>
+        <input type="hidden" name="block_instanceid" value="<?php p($block_instanceid) ?>" />&nbsp;
+        <input type="text" name="query_string" length="50" value="<?php p($query_string) ?>" />&nbsp;
+        <input type="submit" value="<?php print_string('search', 'search') ?>" /> &nbsp;
+        <a href="query.php?a=1&block_instanceid=<?php p($block_instanceid) ?>" ><?php print_string('advancedsearch', 'search') ?></a> |
+        <a href="stats.php?block_instanceid=<?php p($block_instanceid) ?>"><?php print_string('statistics', 'search') ?></a>
     <?php 
     } 
     else {
-        print_box_start();
+        echo $OUTPUT->box_start();
       ?>
         <input type="hidden" name="a" value="<?php p($advanced); ?>"/>
+        <input type="hidden" name="block_instanceid" value="<?php p($block_instanceid) ?>" />
     
         <table border="0" cellpadding="3" cellspacing="3">
     
@@ -222,7 +238,7 @@
         </tr>
     
         <tr>
-          <td><?php print_string('whichmodulestosearch?', 'search') ?>:</td>
+          <td><?php print_string('whichmodulestosearch', 'search') ?>:</td>
           <td>
             <select name="module">
     <?php 
@@ -267,15 +283,15 @@
           <td colspan="3" align="center">
             <table border="0" cellpadding="0" cellspacing="0">
               <tr>
-                <td><a href="query.php"><?php print_string('normalsearch', 'search') ?></a> |</td>
-                <td>&nbsp;<a href="stats.php"><?php print_string('statistics', 'search') ?></a></td>
+                <td><a href="query.php?block_instanceid=<?php p($block_instanceid) ?>"><?php print_string('normalsearch', 'search') ?></a> |</td>
+                <td>&nbsp;<a href="stats.php?block_instanceid=<?php p($block_instanceid) ?>"><?php print_string('statistics', 'search') ?></a></td>
               </tr>
             </table>
           </td>
         </tr>
         </table>
     <?php
-        print_box_end();
+        echo $OUTPUT->box_end();
         } 
     ?>
     </form>
@@ -297,19 +313,19 @@
     print_string('documents', 'search');
     print '.';
     
-    if (!$sq->is_valid_index() and has_capability('moodle/site:doanything', get_context_instance(CONTEXT_SYSTEM))) {
+    if (!$sq->is_valid_index() and has_capability('moodle/site:config', get_context_instance(CONTEXT_SYSTEM))) {
         print '<p>' . get_string('noindexmessage', 'search') . '<a href="indexersplash.php">' . get_string('createanindex', 'search')."</a></p>\n";
     } 
     
     ?>
     </div>
     <?php
-    print_box_end();
+    echo $OUTPUT->box_end();
     
 /// prints all the results in a box
 
     if ($sq->is_valid()) {
-        print_box_start();
+        echo $OUTPUT->box_start();
         
         search_stopwatch();
         $hit_count = $sq->count();
@@ -338,15 +354,23 @@
 
             $searchables = search_collect_searchables(false, false);
 
+            //build a list of distinct user objects needed for results listing.
+            $hitusers = array();
+            foreach ($hits as $listing) {
+                if ($listing->doctype == 'user' and !isset($hitusers[$listing->userid])) {
+                    $hitusers[$listing->userid] = $DB->get_record('user', array('id' => $listing->userid));
+                }
+            }
+            
             foreach ($hits as $listing) {  
                 
-                if ($listing->doctype == 'user'){ // A special handle for users                    
-                    $icon = print_user_picture ($listing->userid, 0, true, 0, true, false) ;
+                if ($listing->doctype == 'user') { // A special handle for users
+                    $icon = $OUTPUT->user_picture($hitusers[$listing->userid]);
                 } else {
-                    $iconpath = $CFG->modpixpath.'/'.$listing->doctype.'/icon.gif';
+                    $iconpath = $OUTPUT->pix_url('icon', $listing->doctype);
                     $icon = "<img align=\"top\" src=\"".$iconpath."\" class=\"activityicon\" alt=\"\"/>";
                 }
-              	$coursename = get_field('course', 'fullname', 'id', $listing->courseid);
+                $coursename = $DB->get_field('course', 'fullname', array('id' => $listing->courseid));
                 $courseword = mb_convert_case(get_string('course', 'moodle'), MB_CASE_LOWER, 'UTF-8');
                 $course = ($listing->doctype != 'user') ? '<strong> ('.$courseword.': \''.$coursename.'\')</strong>' : '' ;
 
@@ -364,8 +388,6 @@
                 echo "<li value='".($listing->number + 1)."'><a href='"
                     .str_replace('DEFAULT_POPUP_SETTINGS', DEFAULT_POPUP_SETTINGS ,$listing->url)
                     ."'>$icon $listing->title</a> $course<br />\n";
-                // print "<li value='".($listing->number+1)."'><a href='".str_replace('DEFAULT_POPUP_SETTINGS', DEFAULT_POPUP_SETTINGS ,$listing->url)."'>$listing->title</a><br />\n"
-                // ."<em>".search_shorten_url($listing->url, 70)."</em><br />\n"
                 echo "{$typestr}: " . $listing->doctype . ", {$scorestr}: " . round($listing->score, 3);
                 if (!empty($listing->author) && !is_numeric($listing->author)){
                     echo ", {$authorstr}: ".$listing->author."\n"
@@ -375,7 +397,7 @@
             echo "</ol>";
             echo $page_links;
         }     
-        print_box_end();
+        echo $OUTPUT->box_end();
     ?>
     <div align="center">
     <?php 
@@ -387,6 +409,6 @@
     
     <?php
     }
-    print_box_end();
-    print_footer();
+    echo $OUTPUT->box_end();
+    echo $OUTPUT->footer();
 ?>
\ No newline at end of file
