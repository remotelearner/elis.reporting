diff --git a/search/update.php b/search/update.php
index 1bd1227..eb75f55 100644
--- a/search/update.php
+++ b/search/update.php
@@ -7,6 +7,7 @@
     * @subpackage search_engine
     * @author Michael Champanis (mchampan) [cynnical@gmail.com], Valery Fremaux [valery.fremaux@club-internet.fr] > 1.8
     * @date 2008/03/31
+    * @version prepared for 2.0
     * @license http://www.gnu.org/copyleft/gpl.html GNU Public License
     *
     * Index asynchronous updator
@@ -24,6 +25,8 @@
         die('Direct access to this script is forbidden.');    ///  It must be included from the cron script
     }
 
+    global $DB;
+
 /// makes inclusions of the Zend Engine more reliable
     ini_set('include_path', $CFG->dirroot.DIRECTORY_SEPARATOR.'search'.PATH_SEPARATOR.ini_get('include_path'));
 
@@ -35,13 +38,13 @@
     // require_login();
     
     if (empty($CFG->enableglobalsearch)) {
-        error(get_string('globalsearchdisabled', 'search'));
+        print_error('globalsearchdisabled', 'search');
     }
     
     /*
     Obsolete with the MOODLE INTERNAL check
-    if (!has_capability('moodle/site:doanything', get_context_instance(CONTEXT_SYSTEM))) {
-        error(get_string('beadmin', 'search'), "$CFG->wwwroot/login/index.php");
+    if (!has_capability('moodle/site:config', get_context_instance(CONTEXT_SYSTEM))) {
+        print_error('beadmin', 'search', get_login_url());
     }
     */
     
@@ -53,8 +56,7 @@
     }
     $dbcontrol = new IndexDBControl();
     $update_count = 0;
-    $indexdate = 0 + @$CFG->search_indexer_update_date;
-    $startupdatedate = time();
+    $mainstartupdatedate = time();
 
 /// indexing changed resources
     
@@ -63,6 +65,13 @@
     if ($mods = search_collect_searchables(false, true)){
         
         foreach ($mods as $mod) {
+            $indexdate = 0;
+            $indexdatestring = 'search_indexer_update_date_'.$mod->name;
+            $startupdatedate = time();
+            if (isset($CFG->$indexdatestring)) {
+                $indexdate = $CFG->$indexdatestring;
+            }
+
             $class_file = $CFG->dirroot.'/search/documents/'.$mod->name.'_document.php';
             $get_document_function = $mod->name.'_single_document';
             $delete_function = $mod->name.'_delete';
@@ -78,8 +87,7 @@
                     $valuesArray = $db_names_function();
                     if ($valuesArray){
                         foreach($valuesArray as $values){
-                        
-                            $where = (!empty($values[5])) ? 'AND ('.$values[5].')' : '';
+                            $where = (isset($values[5]) and $values[5]!='') ? 'AND ('.$values[5].')' : '';
                             $itemtypes = ($values[4] != '*' && $values[4] != 'any') ? " AND itemtype = '{$values[4]}' " : '' ;
     
                             //TODO: check 'in' syntax with other RDBMS' (add and update.php as well)
@@ -89,51 +97,47 @@
                                     docid,
                                     itemtype
                                 FROM 
-                                    {$CFG->prefix}{$table}
+                                    {{$table}}
                                 WHERE
-                                    doctype = '{$values[1]}'
+                                    doctype = ?
                                     $itemtypes
                             ";
-                            $docIds = get_records_sql_menu($query, array($mod->name));
-                            $docIdList = ($docIds) ? implode("','", array_keys($docIds)) : '' ;
-                            
+                            $docIds = $DB->get_records_sql_menu($query, array($mod->name));
+                            if (!empty($docIds)){
+                                list($usql, $params) = $DB->get_in_or_equal(array_keys($docIds));
                             $query = "
                                 SELECT 
                                     id, 
-                                    {$values[0]} as docid
+                                        $values[0] as docid
                                 FROM 
-                                    {$CFG->prefix}{$values[1]} 
+                                        {{$values[1]}}
                                 WHERE 
-                                    {$values[3]} > {$indexdate} AND 
-                                    id IN ('{$docIdList}')
+                                        $values[3] > $indexdate AND 
+                                        id $usql
                                     $where
                             ";
-                            $records = get_records_sql($query);
-                            if (is_array($records)) {
+                                $records = $DB->get_records_sql($query, $params);
+                            } else {
+                                $records = array();
+                            }
+
                                 foreach($records as $record) {
                                     $updates[] = $delete_function($record->docid, $docIds[$record->docid]);
                                 } 
                             } 
-                        }
                         
                         foreach ($updates as $update) {
                             ++$update_count;
+                            $added_doc = false;
                             
-                            //delete old document
+                            //get old document for deletion later
+                            // change from default text only search to include numerals for this search.
+                            Zend_Search_Lucene_Analysis_Analyzer::setDefault(new Zend_Search_Lucene_Analysis_Analyzer_Common_TextNum_CaseInsensitive());
                             $doc = $index->find("+docid:{$update->id} +doctype:{$mod->name} +itemtype:{$update->itemtype}");
                             
-                            //get the record, should only be one
-                            foreach ($doc as $thisdoc) {
-                                mtrace("  Delete: $thisdoc->title (database id = $thisdoc->dbid, index id = $thisdoc->id, moodle instance id = $thisdoc->docid)");
-                                $dbcontrol->delDocument($thisdoc);
-                                $index->delete($thisdoc->id);
-                            } 
-                            
+                            try {
                             //add new modified document back into index
-                            if (!$add = $get_document_function($update->id, $update->itemtype)){
-                                // ignore on errors
-                                continue;
-                            }
+                                $add = $get_document_function($update->id, $update->itemtype);
                             
                             //object to insert into db
                             $dbid = $dbcontrol->addDocument($add);
@@ -142,11 +146,43 @@
                             $add->addField(Zend_Search_Lucene_Field::Keyword('dbid', $dbid));
                             mtrace("  Add: $add->title (database id = $add->dbid, moodle instance id = $add->docid)");
                             $index->addDocument($add);
+                                $added_doc = true;
+                            }
+
+                            catch (dml_write_exception $e) {
+                                mtrace(" Add: FAILED adding '$add->title' ,  moodle instance id = $add->docid , Error: $e->error ");
+                                mtrace($e);
+                                $added_doc = false;
+                            }
+
+                            if ($added_doc) {
+                                // ok we've successfully added the new document so far
+                                // delete single previous old document
+                                try {
+                                    //get the record, should only be one
+                                    foreach ($doc as $thisdoc) {
+                                        mtrace("  Delete: $thisdoc->title (database id = $thisdoc->dbid, index id = $thisdoc->id, moodle instance id = $thisdoc->docid)");
+                                        $dbcontrol->delDocument($thisdoc);
+                                        $index->delete($thisdoc->id);
+                                    }
+                                }
+
+                                catch (dml_write_exception $e) {
+                                    mtrace(" Delete: FAILED deleting '$thisdoc->title' ,  moodle instance id = $thisdoc->docid , Error: $e->error ");
+                                    mtrace($e);
+                                }
+                            }
                         } 
                     }
                     else{
                         mtrace("No types to update.\n");
                     }
+                    //commit changes
+                    $index->commit();
+
+                    //update index date
+                    set_config($indexdatestring, $startupdatedate);
+
                     mtrace("Finished $mod->name.\n");
                 } 
             } 
@@ -157,7 +193,7 @@
     $index->commit();
     
     //update index date
-    set_config("search_indexer_update_date", $startupdatedate);
+    set_config('search_indexer_update_date', $mainstartupdatedate);
     
     mtrace("Finished $update_count updates");
 
