diff --git a/auth/ldap/ntlmsso_magic.php b/auth/ldap/ntlmsso_magic.php
index 9594b92..9c74f87 100644
--- a/auth/ldap/ntlmsso_magic.php
+++ b/auth/ldap/ntlmsso_magic.php
@@ -4,32 +4,32 @@
 // as we will be executing under the OS security
 // context of the user we are trying to login, rather than
 // of the webserver.
-$nomoodlecookie=true;
+define('NO_MOODLE_COOKIES', true);
 
-require_once(dirname(dirname(dirname(__FILE__)))."/config.php");
+require_once(dirname(dirname(dirname(__FILE__))).'/config.php');
 
-//HTTPS is potentially required in this page
-httpsrequired();
+//HTTPS is required in this page when $CFG->loginhttps enabled
+$PAGE->https_required();
+
+$PAGE->set_context(get_context_instance(CONTEXT_SYSTEM));
 
 $authsequence = get_enabled_auth_plugins(true); // auths, in sequence
-if (!in_array('ldap',$authsequence,true)) {
-    print_error('ldap_isdisabled','auth');
+if (!in_array('ldap', $authsequence, true)) {
+    print_error('ldap_isdisabled', 'auth');
 }
 
 $authplugin = get_auth_plugin('ldap');
 if (empty($authplugin->config->ntlmsso_enabled)) {
-    print_error('ntlmsso_isdisabled','auth');
+    print_error('ntlmsso_isdisabled', 'auth_ldap');
 }
 
 $sesskey = required_param('sesskey', PARAM_RAW);
-$file = $CFG->dirroot . '/pix/spacer.gif';
-
-if ($authplugin->ntlmsso_magic($sesskey) 
-    && file_exists($file)) {
+$file = $CFG->dirroot.'/pix/spacer.gif';
 
+if ($authplugin->ntlmsso_magic($sesskey) && file_exists($file)) {
     if (!empty($authplugin->config->ntlmsso_ie_fastpath)) {
         if (check_browser_version('MSIE')) {
-            redirect($CFG->wwwroot . '/auth/ldap/ntlmsso_finish.php');
+            redirect($CFG->wwwroot.'/auth/ldap/ntlmsso_finish.php');
         }
     } 
 
@@ -39,12 +39,12 @@ if ($authplugin->ntlmsso_magic($sesskey)
     header('Content-Length: '.filesize($file));
 
     // Output file
-    $handle=fopen($file,'r');
+    $handle = fopen($file, 'r');
     fpassthru($handle);
     fclose($handle);
     exit;
 } else {
-    print_error('ntlmsso_iwamagicnotenabled','auth');
+    print_error('ntlmsso_iwamagicnotenabled', 'auth_ldap');
 }
 
-?>
+
