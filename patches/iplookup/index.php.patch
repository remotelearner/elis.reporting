diff --git a/iplookup/index.php b/iplookup/index.php
index 7e75bd8..afb5383 100644
--- a/iplookup/index.php
+++ b/iplookup/index.php
@@ -1,41 +1,48 @@
-<?php // $Id$
-///////////////////////////////////////////////////////////////////////////
-//                                                                       //
-// NOTICE OF COPYRIGHT                                                   //
-//                                                                       //
-// Moodle - Modular Object-Oriented Dynamic Learning Environment         //
-//          http://moodle.org                                            //
-//                                                                       //
-// Copyright (C) 2008 onwards  Petr Skoda (skodak)                       //
-//                                                                       //
-// This program is free software; you can redistribute it and/or modify  //
-// it under the terms of the GNU General Public License as published by  //
-// the Free Software Foundation; either version 2 of the License, or     //
-// (at your option) any later version.                                   //
-//                                                                       //
-// This program is distributed in the hope that it will be useful,       //
-// but WITHOUT ANY WARRANTY; without even the implied warranty of        //
-// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         //
-// GNU General Public License for more details:                          //
-//                                                                       //
-//          http://www.gnu.org/copyleft/gpl.html                         //
-//                                                                       //
-///////////////////////////////////////////////////////////////////////////
+<?php
+
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Displays IP address on map.
+ *
+ * This script is not compatible with IPv6.
+ *
+ * @package    core
+ * @subpackage iplookup
+ * @copyright  2008 Petr Skoda (http://skodak.org)
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
 
 require('../config.php');
-require_once($CFG->libdir.'/filelib.php');
-require_once($CFG->libdir.'/geoip/geoipcity.inc');
+require_once('lib.php');
 
 require_login();
 
 $ip   = optional_param('ip', getremoteaddr(), PARAM_HOST);
-$user = optional_param('user', $USER->id, PARAM_INT);
+$user = optional_param('user', 0, PARAM_INT);
 
 if (isset($CFG->iplookup)) {
     //clean up of old settings
     set_config('iplookup', NULL);
 }
 
+$PAGE->set_url('/iplookup/index.php', array('id'=>$ip, 'user'=>$user));
+$PAGE->set_pagelayout('popup');
+$PAGE->set_context(get_context_instance(CONTEXT_SYSTEM));
+
 $info = array($ip);
 $note = array();
 
@@ -51,127 +58,50 @@ if ($match[1] == '127' or $match[1] == '10' or ($match[1] == '172' and $match[2]
     print_error('iplookupprivate', 'error');
 }
 
-if ($user) {
-    if ($user = get_record('user', 'id', $user, 'deleted', 0)) {
-        $info[] = fullname($user);
-    }
-}
-
-if (!empty($CFG->geoipfile) and file_exists($CFG->geoipfile)) {
-    $gi = geoip_open($CFG->geoipfile, GEOIP_STANDARD);
-    $location = geoip_record_by_addr($gi, $ip);
-    geoip_close($gi);
-
-    if (empty($location)) {
-        print_error('iplookupfailed', 'error', '', $ip);
-    }
-    if (!empty($location->city)) {
-        $info[] = $location->city;
-    }
-
-    if (!empty($location->country_code)) {
-        $countries = get_list_of_countries();
-        if (isset($countries[$location->country_code])) {
-            // prefer our localized country names
-            $info[] = $countries[$location->country_code];
-        } else {
-            $info[] = $location->country_name;
-        }
-    }
-    $longitude = $location->longitude;
-    $latitude  = $location->latitude;
-    $note[] = get_string('iplookupmaxmindnote', 'admin');
-
-} else {
-    $ipdata = download_file_content('http://netgeo.caida.org/perl/netgeo.cgi?target='.$ip);
-    if ($ipdata === false) {
-        error('Can not connect to NetGeo server at http://netgeo.caida.org, please check proxy settings or better install MaxMind GeoLite City data file.');
-    }
-    $matches = null;
-    if (!preg_match('/LAT:\s*(-?\d+\.\d+)/s', $ipdata, $matches)) {
-        print_error('iplookupfailed', 'error', '', $ip);
-    }
-    $latitude  = (float)$matches[1];
-    if (!preg_match('/LONG:\s*(-?\d+\.\d+)/s', $ipdata, $matches)) {
-        print_error('iplookupfailed', 'error', '', $ip);
-    }
-    $longitude = (float)$matches[1];
+$info = iplookup_find_location($ip);
 
-    if (preg_match('/CITY:\s*([^<]*)/', $ipdata, $matches)) {
-        if (!empty($matches[1])) {
-            $info[] = s($matches[1]);
-        }
-    }
+if ($info['error']) {
+    // can not display
+    notice($info['error']);
+}
 
-    if (preg_match('/COUNTRY:\s*([^<]*)/', $ipdata, $matches)) {
-        if (!empty($matches[1])) {
-            $countrycode = $matches[1];
-            $countries = get_list_of_countries();
-            if (isset($countries[$countrycode])) {
-                // prefer our localized country names
-                $info[] = $countries[$countrycode];
-            } else {
-                $info[] = $countrycode;
-            }
+if ($user) {
+    if ($user = $DB->get_record('user', array('id'=>$user, 'deleted'=>0))) {
+        // note: better not show full names to everybody
+        if (has_capability('moodle/user:viewdetails', get_context_instance(CONTEXT_USER, $user->id))) {
+            array_unshift($info['title'], fullname($user));
         }
     }
-    $note[] = get_string('iplookupnetgeonote', 'admin');
 }
+array_unshift($info['title'], $ip);
 
-
+$title = implode(' - ', $info['title']);
+$PAGE->set_title(get_string('iplookup', 'admin').': '.$title);
+$PAGE->set_heading($title);
+echo $OUTPUT->header();
 
 if (empty($CFG->googlemapkey)) {
-    $info = implode(' - ', $info);
-    $note = implode('<br />', $note);
-
     $imgwidth  = 620;
     $imgheight = 310;
     $dotwidth  = 18;
     $dotheight = 30;
 
-    $dx = round((($longitude + 180) * ($imgwidth / 360)) - $imgwidth - $dotwidth/2);
-    $dy = round((($latitude + 90) * ($imgheight / 180)));
-
-    print_header(get_string('iplookup', 'admin').': '.$info, $info);
+    $dx = round((($info['longitude'] + 180) * ($imgwidth / 360)) - $imgwidth - $dotwidth/2);
+    $dy = round((($info['latitude'] + 90) * ($imgheight / 180)));
 
     echo '<div id="map" style="width:'.($imgwidth+$dotwidth).'px; height:'.$imgheight.'px;">';
     echo '<img src="earth.jpeg" style="width:'.$imgwidth.'px; height:'.$imgheight.'px" alt="" />';
     echo '<img src="marker.gif" style="width:'.$dotwidth.'px; height:'.$dotheight.'px; margin-left:'.$dx.'px; margin-bottom:'.$dy.'px;" alt="" />';
     echo '</div>';
-    echo '<div id="note">'.$note.'</div>';
-    print_footer('empty');
+    echo '<div id="note">'.$info['note'].'</div>';
 
 } else {
-    $info = implode(' - ', $info);
-    $note = implode('<br />', $note);
-
-    $meta = '
-<script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key='.$CFG->googlemapkey.'" type="text/javascript"></script>
-<script type="text/javascript">
-
-//<![CDATA[
-
-function load() {
-  if (GBrowserIsCompatible()) {
-    var map = new GMap2(document.getElementById("map"));
-    map.addControl(new GSmallMapControl());
-    map.addControl(new GMapTypeControl());
-    var point = new GLatLng('.$latitude.', '.$longitude.');
-    map.setCenter(point, 4);
-    map.addOverlay(new GMarker(point));
-    map.setMapType(G_HYBRID_MAP);
-  }
-}
-
-//]]>
-</script>
-';
-
-    print_header(get_string('iplookup', 'admin').': '.$info, $info, '', '', $meta, false, '&nbsp;', '', false, 'onload="load()" onunload="GUnload()"');
+    $PAGE->requires->js(new moodle_url("http://maps.google.com/maps?file=api&v=2&key=$CFG->googlemapkey"));
+    $module = array('name'=>'core_iplookup', 'fullpath'=>'/iplookup/module.js');
+    $PAGE->requires->js_init_call('M.core_iplookup.init', array($info['latitude'], $info['longitude']), true, $module);
 
     echo '<div id="map" style="width: 650px; height: 360px"></div>';
-    echo '<div id="note">'.$note.'</div>';
-    print_footer('empty');
+    echo '<div id="note">'.$info['note'].'</div>';
 }
 
-?>
+echo $OUTPUT->footer();
