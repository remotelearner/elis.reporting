diff --git a/filter/tex/filter.php b/filter/tex/filter.php
index 894df1a..0b62fc1 100644
--- a/filter/tex/filter.php
+++ b/filter/tex/filter.php
@@ -1,46 +1,55 @@
-<?PHP
-/////////////////////////////////////////////////////////////////////////////
-//                                                                         //
-// NOTICE OF COPYRIGHT                                                     //
-//                                                                         //
-// Moodle - Filter for converting TeX expressions to cached gif images     //
-//                                                                         //
-// Copyright (C) 2004 Zbigniew Fiedorowicz fiedorow@math.ohio-state.edu    //
-// Originally based on code provided by Bruno Vernier bruno@vsbeducation.ca//
-// This program is free software; you can redistribute it and/or modify    //
-// it under the terms of the GNU General Public License as published by    //
-// the Free Software Foundation; either version 2 of the License, or       //
-// (at your option) any later version.                                     //
-//                                                                         //
-// This program is distributed in the hope that it will be useful,         //
-// but WITHOUT ANY WARRANTY; without even the implied warranty of          //
-// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the           //
-// GNU General Public License for more details:                            //
-//                                                                         //
-//          http://www.gnu.org/copyleft/gpl.html                           //
-//                                                                         //
-/////////////////////////////////////////////////////////////////////////////
-//-------------------------------------------------------------------------
-// NOTE: This Moodle text filter converts TeX expressions delimited
-// by either $$...$$ or by <tex...>...</tex> tags to gif images using
-// mimetex.cgi obtained from http://www.forkosh.com/mimetex.html authored by
-// John Forkosh john@forkosh.com.  Several binaries of this areincluded with
-// this distribution.
-// Note that there may be patent restrictions on the production of gif images
-// in Canada and some parts of Western Europe and Japan until July 2004.
-//-------------------------------------------------------------------------
-/////////////////////////////////////////////////////////////////////////////
-//  To activate this filter, add a line like this to your                  //
-//  list of filters in your Filter configuration:                          //
-//                                                                         //
-//       filter/tex/filter.php                                             //
-/////////////////////////////////////////////////////////////////////////////
-
-function string_file_picture_tex($imagefile, $tex= "", $height="", $width="", $align="middle", $alt='') {
-    global $CFG;
-
-    if ($alt==='') {
-        $alt = s($tex);
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Moodle - Filter for converting TeX expressions to cached gif images
+ *
+ * This Moodle text filter converts TeX expressions delimited
+ * by either $$...$$ or by <tex...>...</tex> tags to gif images using
+ * mimetex.cgi obtained from http: *www.forkosh.com/mimetex.html authored by
+ * John Forkosh john@forkosh.com.  Several binaries of this areincluded with
+ * this distribution.
+ * Note that there may be patent restrictions on the production of gif images
+ * in Canada and some parts of Western Europe and Japan until July 2004.
+ *
+ * @package    filter
+ * @subpackage tex
+ * @copyright  2004 Zbigniew Fiedorowicz fiedorow@math.ohio-state.edu
+ *             Originally based on code provided by Bruno Vernier bruno@vsbeducation.ca
+ * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die;
+
+/**
+ * Create TeX image link.
+ *
+ * @param string $imagefile name of file
+ * @param string $tex TeX notation (html entities already decoded)
+ * @param int $height O means automatic
+ * @param int $width O means automatic
+ * @param string $align
+ * @param string $alt
+ * @return string HTML markup
+ */
+function filter_text_image($imagefile, $tex, $height, $width, $align, $alt) {
+    global $CFG, $OUTPUT;
+
+    if (!$imagefile) {
+        throw new coding_exception('image file argument empty in filter_text_image()');
     }
 
     // Work out any necessary inline style.
@@ -61,49 +70,48 @@ function string_file_picture_tex($imagefile, $tex= "", $height="", $width="", $a
     }
 
     // Prepare the title attribute.
-    if ($tex) {
-        $tex = str_replace('&','&amp;',$tex);
-        $tex = str_replace('<','&lt;',$tex);
-        $tex = str_replace('>','&gt;',$tex);
-        $tex = str_replace('"','&quot;',$tex);
-        $tex = str_replace("\'",'&#39;',$tex);
         // Note that we retain the title tag as TeX format rather than using
         // the alt text, even if supplied. The alt text is intended for blind 
         // users (to provide a text equivalent to the equation) while the title 
         // is there as a convenience for sighted users who want to see the TeX 
         // code. 
-        $title = "title=\"$tex\"";
-    }
+    $title = 'title="'.s($tex).'"';
 
-    // Build the output.
-    $output = "";
-    if ($imagefile) {
-        if (!file_exists("$CFG->dataroot/filter/tex/$imagefile") && has_capability('moodle/site:config', get_context_instance(CONTEXT_SYSTEM))) {
-          $output .= "<a href=\"$CFG->wwwroot/filter/tex/texdebug.php\">";
+    if ($alt === '') {
+        $alt = s($tex);
         } else {
-          $output .= "<a target=\"popup\" title=\"TeX\" href=";
-          $output .= "\"$CFG->wwwroot/filter/tex/displaytex.php?";
-          $output .= urlencode($tex) . "\" onclick=\"return openpopup('/filter/tex/displaytex.php?";
-          $output .= urlencode($tex) . "', 'popup', 'menubar=0,location=0,scrollbars,";
-          $output .= "resizable,width=300,height=240', 0);\">";
+        $alt = s(html_entity_decode($tex, ENT_QUOTES, 'UTF-8'));
         }
-        $output .= "<img class=\"texrender\" $title alt=\"$alt\" src=\"";
+
+    // Build the output.
+    $anchorcontents = "<img class=\"texrender\" $title alt=\"$alt\" src=\"";
         if ($CFG->slasharguments) {        // Use this method if possible for better caching
-            $output .= "$CFG->wwwroot/filter/tex/pix.php/$imagefile";
+        $anchorcontents .= "$CFG->wwwroot/filter/tex/pix.php/$imagefile";
         } else {
-            $output .= "$CFG->wwwroot/filter/tex/pix.php?file=$imagefile";
+        $anchorcontents .= "$CFG->wwwroot/filter/tex/pix.php?file=$imagefile";
         }
-        $output .= "\" $style/>";
-        $output .= "</a>";
+    $anchorcontents .= "\" $style/>";
+
+    if (!file_exists("$CFG->dataroot/filter/tex/$imagefile") && has_capability('moodle/site:config', get_context_instance(CONTEXT_SYSTEM))) {
+        $link = '/filter/tex/texdebug.php';
+        $action = null;
     } else {
-        $output .= "Error: must pass URL or course";
+        $link = new moodle_url('/filter/tex/displaytex.php', array('texexp'=>$tex));
+        $action = new popup_action('click', $link, 'popup', array('width'=>320,'height'=>240));
     }
+    $output = $OUTPUT->action_link($link, $anchorcontents, $action, array('title'=>'TeX')); //TODO: the popups do not work when text caching is enabled!!
+
     return $output;
 }
 
-function tex_filter ($courseid, $text) {
 
-    global $CFG;
+/**
+ * TeX filtering class.
+ */
+class filter_tex extends moodle_text_filter {
+    function filter($text, array $options = array()) {
+
+        global $CFG, $DB;
 
     /// Do a quick check using stripos to avoid unnecessary work
     if (!preg_match('/<tex/i',$text) and !strstr($text,'$$') and !strstr($text,'\\[') and !preg_match('/\[tex/i',$text)) { //added one more tag (dlnsk)
@@ -117,9 +125,9 @@ function tex_filter ($courseid, $text) {
 #    }
 #    if (strstr($scriptname,'post.php')) {
 #        $parent = forum_get_post_full($_GET['reply']);
-#        $discussion = get_record("forum_discussions","id",$parent->discussion);
+#        $discussion = $DB->get_record("forum_discussions", array("id"=>$parent->discussion));
 #    } else if (strstr($scriptname,'discuss.php')) {
-#        $discussion = get_record("forum_discussions","id",$_GET['d'] );
+#        $discussion = $DB->get_record("forum_discussions", array("id"=>$_GET['d']));
 #    } else {
 #        return $text;
 #    }
@@ -128,9 +136,9 @@ function tex_filter ($courseid, $text) {
 #    }
     $text .= ' ';
     preg_match_all('/\$(\$\$+?)([^\$])/s',$text,$matches);
-    for ($i=0;$i<count($matches[0]);$i++) {
-        $replacement = str_replace('$','&#x00024;',$matches[1][$i]).$matches[2][$i];
-        $text = str_replace($matches[0][$i],$replacement,$text);
+        for ($i=0; $i<count($matches[0]); $i++) {
+            $replacement = str_replace('$','&#x00024;', $matches[1][$i]).$matches[2][$i];
+            $text = str_replace($matches[0][$i], $replacement, $text);
     }
 
     // <tex> TeX expression </tex>
@@ -146,7 +154,7 @@ function tex_filter ($courseid, $text) {
         $texexp = str_replace('</nolink>','',$texexp);
         $texexp = str_replace('<span class="nolink">','',$texexp);
         $texexp = str_replace('</span>','',$texexp);
-        $texexp = eregi_replace("<br[[:space:]]*\/?>", '', $texexp);  //dlnsk
+            $texexp = preg_replace("/<br[[:space:]]*\/?>/i", '', $texexp);  //dlnsk
         $align = "middle";
         if (preg_match('/^align=bottom /',$texexp)) {
           $align = "text-bottom";
@@ -155,19 +163,29 @@ function tex_filter ($courseid, $text) {
           $align = "text-top";
           $texexp = preg_replace('/^align=top /','',$texexp);
         }
+
+            // decode entities encoded by editor, luckily there is very little chance of double decoding
+            $texexp = html_entity_decode($texexp, ENT_QUOTES, 'UTF-8');
+
+            if ($texexp === '') {
+                continue;
+            }
+
         $md5 = md5($texexp);
-        if (! $texcache = get_record("cache_filters","filter","tex", "md5key", $md5)) {
+            if (!$DB->record_exists("cache_filters", array("filter"=>"tex", "md5key"=>$md5))) {
+                $texcache = new stdClass();
             $texcache->filter = 'tex';
             $texcache->version = 1;
             $texcache->md5key = $md5;
-            $texcache->rawtext = addslashes($texexp);
+                $texcache->rawtext = $texexp;
             $texcache->timemodified = time();
-            insert_record("cache_filters",$texcache, false);
+                $DB->insert_record("cache_filters", $texcache, false);
         }
         $filename = $md5 . ".{$CFG->filter_tex_convertformat}";
-        $text = str_replace( $matches[0][$i], string_file_picture_tex($filename, $texexp, '', '', $align, $alt), $text);
+            $text = str_replace( $matches[0][$i], filter_text_image($filename, $texexp, 0, 0, $align, $alt), $text);
     }
     return $text;
+    }
 }
 
-?>
+
