diff --git a/filter/tex/pix.php b/filter/tex/pix.php
index 2d9d419..deb43d5 100644
--- a/filter/tex/pix.php
+++ b/filter/tex/pix.php
@@ -1,24 +1,18 @@
-<?PHP // $Id$
+<?PHP
       // This function fetches math. images from the data directory
       // If not, it obtains the corresponding TeX expression from the cache_tex db table
       // and uses mimeTeX to create the image file
 
-    $nomoodlecookie = true;     // Because it interferes with caching
+// disable moodle specific debug messages and any errors in output
+define('NO_DEBUG_DISPLAY', true);
+define('NO_MOODLE_COOKIES', true); // Because it interferes with caching
 
     require_once('../../config.php');
 
-    if (empty($CFG->textfilters)) {
-        error ('Filter not enabled!');
-    } else {
-        $filters = explode(',', $CFG->textfilters);
-        if (array_search('filter/tex', $filters) === FALSE) {
-            error ('Filter not enabled!');
-        }
+    if (!filter_is_enabled('filter/tex')) {
+        print_error('filternotenabled');
     }
 
-    // disable moodle specific debug messages
-    disable_debugging();
-
     require_once($CFG->libdir.'/filelib.php');
     require_once($CFG->dirroot.'/filter/tex/lib.php');
     require_once($CFG->dirroot.'/filter/tex/latex.php');
@@ -26,7 +20,7 @@
     $cmd    = '';               // Initialise these variables
     $status = '';
 
-    $relativepath = get_file_argument('pix.php');
+    $relativepath = get_file_argument();
 
     $args = explode('/', trim($relativepath, '/'));
 
@@ -34,12 +28,12 @@
         $image    = $args[0];
         $pathname = $CFG->dataroot.'/filter/tex/'.$image;
     } else {
-        error('No valid arguments supplied');
+        print_error('invalidarguments', 'error');
     }
 
     if (!file_exists($pathname)) {
         $md5 = str_replace(".{$CFG->filter_tex_convertformat}",'',$image);
-        if ($texcache = get_record('cache_filters', 'filter', 'tex', 'md5key', $md5)) {
+        if ($texcache = $DB->get_record('cache_filters', array('filter'=>'tex', 'md5key'=>$md5))) {
             if (!file_exists($CFG->dataroot.'/filter/tex')) {
                 make_upload_directory('filter/tex');
             }
@@ -48,7 +42,7 @@
             $latex = new latex();
             $density = $CFG->filter_tex_density;
             $background = $CFG->filter_tex_latexbackground;
-            $texexp = html_entity_decode($texcache->rawtext);
+            $texexp = $texcache->rawtext; // the entities are now decoded before inserting to DB
             $latex_path = $latex->render($texexp, $md5, 12, $density, $background);
             if ($latex_path) {
                 copy($latex_path, $pathname);
@@ -61,7 +55,7 @@
                 $texexp = str_replace('&gt;', '>', $texexp);
                 $texexp = preg_replace('!\r\n?!', ' ', $texexp);
                 $texexp = '\Large '.$texexp;
-                $cmd = tex_filter_get_cmd($pathname, $texexp);
+                $cmd = filter_tex_get_cmd($pathname, $texexp);
                 system($cmd, $status);
             }
         }
@@ -80,4 +74,3 @@
             echo "Please turn on debug mode in site configuration to see more info here.";
         }
     }
-?>
